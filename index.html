<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>FIN-JOD · บันทึกรายรับ–รายจ่าย–ออมเงิน + หนี้</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<style>
    *{ box-sizing:border-box }
    :root{
        /* === NEW COLOR PALETTE (INSPIRED BY IMAGE) === */
        --bg-start: #f3e8ff;
        --bg-end: #e9d5ff;
        --primary-brand-start: #8B5CF6;
        --primary-brand-end: #6366F1;
        --primary-brand-solid: #7C3AED;
        --primary-grad: linear-gradient(135deg, var(--primary-brand-start), var(--primary-brand-end));
        
        --card-bg: rgba(255, 255, 255, 0.7);
        --card-border: rgba(255, 255, 255, 0.9);
        --card-shadow: 0 10px 30px rgba(100, 100, 150, 0.1);

        --text-header: #FFFFFF;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        
        --line: #e2e8f0;
        
        --green-color: #10B981;
        --red-color: #F43F5E;
        --yellow-color: #FBBF24;
        --blue-color: #3B82F6;
        --cyan-color: #14B8A6;
    }

    /* === Base Layout & Typography === */
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        font-family: 'Kanit', sans-serif;
        background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
    }
    
    .container {
        width: 100%;
        margin: 0;
        flex: 1;
        overflow: hidden;
        padding: 1.5rem;
        padding-bottom: 0; 
        display: flex;
        flex-direction: column;
    }

    #app {
        flex: 1;
        overflow-y: auto;
        padding-bottom: calc(64px + 16px + 16px + env(safe-area-inset-bottom, 16px));
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.1) transparent;
    }
    #app::-webkit-scrollbar { width: 8px; }
    #app::-webkit-scrollbar-track { background: transparent; }
    #app::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 10px; }

    .app-header { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 1.5rem; 
        padding: 0 0.5rem;
    }
    .user-info { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
        font-size: 1.1rem; 
        color: var(--text-primary); 
        font-weight: 600; 
        cursor: pointer; 
    }
    #btnLogout { font-size: 0.9rem; padding: 0.5rem 1rem; min-height: 0; }
    .user-info .icon { 
        font-size: 1rem; 
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-grad);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .section{ display:none } 
    .section.active{ display:block; animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* === Cards (Core of the new design) === */
    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 28px;
        padding: clamp(1.5rem, 4vw, 2rem);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
    }
    .data-group {
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: clamp(1rem, 3vw, 1.5rem);
        margin-bottom: 1.25rem;
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* === Forms & Buttons === */
    .row{ display:flex; flex-wrap:wrap; gap:1.25rem; margin-bottom:1.25rem; align-items:flex-start }
    .col{ flex:1 1 46%; display:flex; flex-direction:column; gap:.5rem; min-width:220px }
    label{ color:var(--text-secondary); font-size:.9rem; font-weight: 500; padding-left: 0.25rem;}
    
    input, select, button {
        padding: 0.9rem 1.1rem; 
        font-size:16px; 
        border-radius:16px; /* More rounded */
        border: 1px solid var(--line);
        background: #FFFFFF;
        color:var(--text-primary); 
        min-height:52px; 
        font-family: 'Kanit', sans-serif;
        transition: all 0.2s ease-in-out;
    }
    input:focus, select:focus {
        border-color: var(--primary-brand-solid);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.25);
        outline: none;
    }
    input::placeholder { color: #9ca3af; }
    input[type=number]{ text-align:right; -moz-appearance:textfield }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

    button{
        background: var(--primary-grad); 
        border:none; 
        color: #fff; 
        font-weight:600; 
        cursor:pointer;
        transition: transform 0.2s, box-shadow 0.2s; 
        touch-action:manipulation;
    }
    @media (hover:hover) and (pointer:fine){ 
        button:hover{ 
            transform: translateY(-3px); 
            box-shadow: 0 6px 20px rgba(0,0,0,.12); 
        } 
    }
    button:active { transform: translateY(0); box-shadow: var(--card-shadow); }
    button:disabled{ opacity:.6; cursor:not-allowed; transform: none; box-shadow: none; }
    
    .btn-green{ background: linear-gradient(135deg, #22c55e, #10b981) }
    .btn-danger{ background: linear-gradient(135deg, #f43f5e, #ef4444); }
    .btn-blue{ background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .btn-cyan{ background: linear-gradient(135deg, #14b8a6, #0d9488); }

    /* Segmented Control for Transaction Type */
    .segmented-control {
        display: flex;
        background-color: #e5e7eb;
        border-radius: 14px;
        padding: 4px;
        width: 100%;
    }
    .seg-btn {
        flex: 1;
        padding: 0.5rem 0.25rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 11px;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .seg-btn.active {
        background: #ffffff;
        color: var(--primary-brand-solid);
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    /* === Dashboard Specific Styles === */
    .dashboard-header-card {
        background: var(--primary-grad);
        color: var(--text-header);
        text-align: center;
    }
    .dashboard-header-card .muted {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 400;
        font-size: 1rem;
    }
    .dashboard-header-card .main-figure {
        font-size: clamp(2.5rem, 10vw, 3.5rem);
        font-weight: 700;
        margin: 0.5rem 0;
        line-height: 1.1;
    }

    .kpi { 
        display:grid; 
        grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); 
        gap:1rem; 
        margin-bottom:1rem; 
    }
    .kpi .card{ 
        padding: 1.25rem;
        text-align: center;
        transition: transform .2s, box-shadow .2s;
    }
    .kpi .card:hover { transform: translateY(-5px); box-shadow: var(--card-shadow); }
    .kpi .card .kpi-icon { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .kpi .card .muted { font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.25rem; }
    .kpi .card .kpi-value { font-size:1.5rem; font-weight:700; color: var(--text-primary); }

    /* Progress Bars */
    .bar-track{ 
        height:12px; 
        background:#e5e7eb; 
        border-radius:999px; 
        overflow:hidden;
        margin-top: 0.5rem;
    }
    .bar-fill{ height:100%; width:0% }
    #budgetBar{ background: linear-gradient(90deg, #60a5fa, #fbbf24, #f87171); }
    #savingBar{ background: linear-gradient(90deg, var(--cyan-color), var(--green-color)); }
    .inline-status { font-size: 0.9rem; }

    /* === Tables === */
    .table-viewport{ border-radius:18px; border:1px solid var(--line); background: rgba(255,255,255,0.4); overflow: hidden; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:.95rem }
    th,td{ border-bottom:1px solid var(--line); padding:.9rem .75rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align: left; }
    tr:last-child td { border-bottom: none; }
    th{ color:var(--text-secondary); font-weight:600; background:rgba(249, 250, 251, 0.85); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    tbody tr:hover{ background: rgba(255,255,255,0.7) }

    .badge{ padding:.4rem .85rem; border-radius:999px; font-size:.8rem; font-weight: 600; }
    .badge-inc{ background-color: #dcfce7; color: #166534; }
    .badge-exp{ background-color: #fee2e2; color: #991b1b; }
    .badge-sav{ background-color: #ccfbf1; color: #0f766e; }
    .badge-debt{ background-color: #dbeafe; color: #1e40af; }
    
    /* === Bottom Navigation === */
    .bottom-nav {
        position: fixed;
        bottom: calc(16px + env(safe-area-inset-bottom, 0px)); 
        left: 50%;
        transform: translateX(-50%);
        width: min(400px, calc(100% - 32px));
        height: 68px;
        padding: 0 16px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid rgba(255,255,255,0.9);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 50;
        border-radius: 999px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        background: none;
        border: none;
        padding: 4px 12px;
        font-size: 0.8rem;
        font-family: 'Kanit', sans-serif;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
        min-height: 56px;
        position: relative;
    }
    .nav-btn:hover { color: var(--primary-brand-solid); transform: none; box-shadow: none; }
    .nav-btn.active { color: var(--primary-brand-solid); font-weight: 700; }
    .nav-btn svg { width: 26px; height: 26px; stroke-width: 2; transition: transform 0.2s; }
    .nav-btn.active svg { transform: scale(1.1); }
    .nav-btn.active::after {
        content: '';
        position: absolute;
        bottom: 4px;
        height: 4px;
        width: 4px;
        border-radius: 50%;
        background-color: var(--primary-brand-solid);
    }

    /* === Modals === */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.3); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:60; padding: 1rem; }
    .modal-backdrop.show{ display:flex }
    .modal{
        width:min(640px,100%);
        background: var(--bg-start);
        border:1px solid var(--card-border);
        border-radius:24px;
        box-shadow:0 20px 60px rgba(0,0,0,.2);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }
    .modal-header { padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--line); }
    .modal .title{ font-weight:700; margin: 0; font-size: 1.25rem; color: var(--text-primary); }
    .modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem 1.5rem; border-top: 1px solid var(--line); }
    .modal .actions{ display:flex; gap:.75rem; justify-content:flex-end; margin-top: 0; }
    
    /* Other utilities */
    .hide{ display:none !important }
    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:99; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
    #overlay.show{ display:flex }
    .spinner{ width:58px; height:58px; border:6px solid rgba(255,255,255,.45); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .skeleton{ position:relative; overflow:hidden; background:#e5e7eb; border-radius:8px; min-height:20px }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent); animation:skeleton 1.2s infinite }
    @keyframes skeleton{ 100%{ transform:translateX(100%) } }
    
    @media(max-width:768px){
        .container { padding: 1rem; padding-bottom: 0; }
        .table-viewport{ max-height:none; overflow-y:visible; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        table{ min-width:720px; table-layout:auto }
    }
</style>

<div class="container">
    <div id="app" class="hide">
        
        <div class="app-header">
            <div class="user-info" id="userInfoToggle">
                <span class="icon" id="userInitial"></span> 
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">ยินดีต้อนรับ</div>
                    <div id="who" style="font-weight: 600; line-height: 1.2;"></div>
                </div>
            </div>
            <button id="btnLogout" class="hide" style="background: transparent; border: 1px solid var(--line); color: var(--text-secondary);">ออกจากระบบ</button>
        </div>

        <section id="tab-add" class="section active card">
            <div class="row">
                <div class="col">
                    <label for="txDate">วันที่</label>
                    <input id="txDate" type="date" />
                </div>

                <div class="col">
                    <label>ประเภท</label>
                     <div class="segmented-control">
                        <button id="btnTypeExp" class="seg-btn active">รายจ่าย</button>
                        <button id="btnTypeInc" class="seg-btn">รายรับ</button>
                        <button id="btnTypeSav" class="seg-btn">ออมเงิน</button>
                    </div>
                </div>
            </div>
            
             <div class="row">
                <div class="col" id="colCat">
                    <label for="txCat">หมวดหมู่</label>
                    <select id="txCat"></select>
                </div>

                <div class="col hide" id="colDebt">
                    <label for="txDebt">เลือกเจ้าหนี้</label>
                    <select id="txDebt"></select>
                </div>

                <div class="col" id="colAmount">
                    <label for="txAmount">จำนวนเงิน (บาท)</label>
                    <input id="txAmount" type="number" step="0.01" placeholder="0.00" inputmode="decimal">
                </div>
            </div>

            <div class="row save-row" style="align-items:flex-end; gap:1rem">
                <div class="col" style="flex:1 1 0">
                    <label for="txNote">หมายเหตุ</label>
                    <input id="txNote" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)" maxlength="500">
                </div>
                <div class="col" style="flex:0 0 auto">
                    <button id="btnSave" class="btn-green" style="width: 100%; min-width:180px">บันทึกรายการ</button>
                </div>
            </div>
            
            <hr style="border:none; border-top: 1px solid var(--line); margin: 2rem 0 1.5rem;">
            
            <div style="text-align:center; color: var(--text-secondary);">
                <span style="font-weight:500;">ต้องการบันทึกหนี้?</span>
                <button id="btnTypeDebtRepay" class="seg-btn" style="display:inline-block; flex:none; width:auto; padding: 0.5rem 1rem; margin: 0 0.5rem;">จ่ายหนี้</button>
                <button id="btnTypeDebtBorrow" class="seg-btn" style="display:inline-block; flex:none; width:auto; padding: 0.5rem 1rem;">กู้หนี้</button>
            </div>
            
            <div class="col hide" id="colDebtRepayFields" style="width:100%; margin-top:1.5rem;">
                <label>รายละเอียดการจ่ายหนี้</label>
                <div class="row" style="gap:.5rem; margin:0">
                    <div class="col"><input id="txInt" type="number" step="0.01" placeholder="จ่ายดอก (บาท)"></div>
                    <div class="col"><input id="txPrin" type="number" step="0.01" placeholder="จ่ายต้น (บาท)"></div>
                </div>
            </div>

             <select id="txType" class="hide" aria-hidden="true">
                <option value="expense" selected>รายจ่าย</option>
                <option value="income">รายรับ</option>
                <option value="saving">ออมเงิน</option>
                <option value="debt_repay">จ่ายหนี้</option>
                <option value="debt_borrow">กู้หนี้</option>
            </select>
        </section>

        <section id="tab-debt" class="section card">
            <div class="data-group">
                <div style="color: var(--text-secondary); margin-bottom:.5rem">เพิ่มเจ้าหนี้</div>
                <div class="row">
                    <div class="col"><label for="dName">ชื่อเจ้าหนี้</label><input id="dName" placeholder="เช่น บัตร X / เพื่อน A"></div>
                    <div class="col"><label for="dRate">อัตราดอกเบี้ยต่อปี (%)</label><input id="dRate" type="number" step="0.01" placeholder="เช่น 18"></div>
                    <div class="col"><label for="dPrincipal">ยอดตั้งต้น (ไม่บังคับ)</label><input id="dPrincipal" type="number" step="0.01" placeholder="เช่น 10000"></div>
                    <div class="col" style="align-self:flex-end"><button id="btnAddDebt" class="btn-blue">+ เพิ่มเจ้าหนี้</button></div>
                </div>
            </div>
            <div class="data-group">
                 <div style="margin-bottom:1rem; display:flex; justify-content:space-between; align-items:center;">
                     <div style="color: var(--text-secondary);">รายการเจ้าหนี้ (ที่ยังเปิดอยู่)</div>
                     <button id="btnLoadDebtTx" class="btn-blue" style="padding: 0.5rem 1rem; min-height:0; font-size:0.9rem;">รีเฟรช</button>
                 </div>
                <div class="table-viewport">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:200px">เจ้าหนี้</th>
                                <th style="width:110px" class="right">% ต่อปี</th>
                                <th style="width:140px" class="right">รวมที่ต้องจ่าย</th>
                                <th style="width:200px">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="tblDebts"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-dash" class="section">
            <div class="card dashboard-header-card">
                 <div class="muted">คงเหลือ (จากรายรับ-รายจ่าย)</div>
                 <div id="sumNet" class="main-figure skeleton"></div>
                 <div class="muted">ในช่วงวันที่ <b id="rangeBadge" style="color:white"></b></div>
            </div>

            <div class="row" style="margin-bottom:0.5rem">
                 <div class="col"><label for="fFrom">จาก</label><input id="fFrom" type="date"></div>
                 <div class="col"><label for="fTo">ถึง</label><input id="fTo" type="date"></div>
            </div>
             <div class="segmented-control" style="margin-bottom:1.5rem;">
                <button class="seg-btn" id="btnToday">วันนี้</button>
                <button class="seg-btn" id="btn7">7 วัน</button>
                <button class="seg-btn" id="btn30">30 วัน</button>
                <button class="seg-btn" id="btnMonth">เดือนนี้</button>
                <button class="seg-btn" id="btnYear">ปีนี้</button>
            </div>
            
            <div class="kpi" id="kpiWrap">
                <div class="card">
                    <div class="kpi-icon">💰</div>
                    <div class="muted">รายรับรวม</div>
                    <div id="sumIncome" class="kpi-value skeleton"></div>
                </div>
                <div class="card">
                    <div class="kpi-icon">🧾</div>
                    <div class="muted">รายจ่ายรวม</div>
                    <div id="sumExpense" class="kpi-value skeleton"></div>
                </div>
                <div class="card">
                    <div class="kpi-icon">🏦</div>
                    <div class="muted">ออมเงินสุทธิ</div>
                    <div id="sumSaving" class="kpi-value skeleton"></div>
                </div>
                 <div class="card">
                    <div class="kpi-icon">📉</div>
                    <div class="muted">หนี้คงเหลือ</div>
                    <div id="sumDebt" class="kpi-value skeleton"></div>
                </div>
            </div>

            <div class="card">
                <div class="row">
                    <div class="col">
                        <label for="budgetThisMonth">งบรายจ่ายเดือนนี้ (บาท)</label>
                        <input id="budgetThisMonth" type="number" min="0" step="0.01" placeholder="เช่น 10000">
                    </div>
                    <div class="col">
                        <label for="savingGoalThisMonth">เป้าออมเดือนนี้ (บาท)</label>
                        <input id="savingGoalThisMonth" type="number" min="0" step="0.01" placeholder="เช่น 1500">
                    </div>
                     <div class="col" style="align-self:flex-end"><button id="btnSaveBudget" class="btn-blue">บันทึก</button></div>
                </div>

                <div class="inline-status" style="color:var(--text-secondary)">
                    <span>ใช้ไป: <b id="budgetUsedPct" style="color:var(--text-primary)">—</b></span> | <span id="budgetStatus"></span>
                </div>
                <div class="bar-track"><div id="budgetBar" class="bar-fill"></div></div>

                <div class="inline-status" style="margin-top:1rem; color: var(--text-secondary)">
                    <span>ออมแล้ว: <b id="savingGoalPct" style="color:var(--text-primary)">—</b></span> | <span id="savingGoalStatus"></span>
                </div>
                <div class="bar-track"><div id="savingBar" class="bar-fill"></div></div>
            </div>

            <div class="card">
                <div style="color: var(--text-secondary); margin-bottom:1rem">รายจ่ายตามหมวด</div>
                <div id="noDataExp" class="muted hide">ยังไม่มีข้อมูลในช่วงนี้</div>
                <div class="chart-wrap" style="height:260px; width:100%;"><canvas id="chartExp"></canvas></div>
            </div>

            <div class="card">
                 <div style="color: var(--text-secondary); margin-bottom:1rem">กระแสเงินสด (รายวัน & สะสม)</div>
                <div id="noDataFlow" class="muted hide">ยังไม่มีข้อมูลในช่วงนี้</div>
                <div class="chart-wrap" style="height:260px; width:100%;"><canvas id="chartFlow"></canvas></div>
            </div>
        </section>

        <section id="tab-list" class="section card">
            <div style="color: var(--text-secondary); margin-bottom:1rem">รายการทั้งหมด (ในช่วงวันที่เลือก)</div>
            <div class="table-viewport">
                <table>
                    <thead><tr>
                        <th style="width:110px">วันที่</th>
                        <th style="width:160px">ประเภท</th>
                        <th>หมวด/หมายเหตุ</th>
                        <th class="right" style="width:130px">จำนวน</th>
                        <th style="width:92px"></th>
                    </tr></thead>
                    <tbody id="tblBody"></tbody>
                </table>
            </div>
            <div id="emptyList" class="muted" style="margin-top:1rem; display:none; text-align:center;">ยังไม่มีรายการ</div>
        </section>
    </div>

    <div id="loginBox" class="card" style="max-width: 420px; margin: auto;">
        <h2 style="text-align: center; margin-top: 0; color: var(--text-primary);">FIN-JOD  financiero</h2>
        <div class="row">
            <div class="col" style="flex: 1 1 100%;">
                <label for="inpUser">User ID</label>
                <input id="inpUser" placeholder="กรอกชื่อผู้ใช้งาน" autocomplete="username"/>
            </div>
            <div class="col" style="flex: 1 1 100%;">
                <label for="inpPin">PIN</label>
                <input id="inpPin" type="password" placeholder="กรอกรหัสผ่าน" autocomplete="current-password"/>
            </div>
        </div>
        <div class="row" style="margin-top: 1rem;">
            <button id="btnLogin" class="btn-green" style="width: 100%;">เข้าสู่ระบบ</button>
        </div>
        <div id="loginMsg" style="text-align:center; color: var(--red-color); min-height: 1.2rem;"></div>
    </div>
</div>
    
<nav class="bottom-nav">
    <button class="nav-btn active" data-tab="add">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        <span>บันทึก</span>
    </button>
    <button class="nav-btn" data-tab="debt">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" /></svg>
        <span>หนี้</span>
    </button>
    <button class="nav-btn" data-tab="dash">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-12a2.25 2.25 0 01-2.25-2.25V3m16.5 0h-16.5M12 12.75h.008v.008H12v-.008z" /></svg>
        <span>ภาพรวม</span>
    </button>
    <button class="nav-btn" data-tab="list">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
        <span>รายการ</span>
    </button>
</nav>

<div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
        <div class="modal-header"><div id="editTitle" class="title">แก้ไขรายการ</div></div>
        <div class="modal-body">
            <input id="editTxId" type="hidden">
            <div class="row">
                <div class="col"><label for="editDate">วันที่</label><input id="editDate" type="date"></div>
                <div class="col">
                    <label for="editType">ประเภท</label>
                    <select id="editType">
                        <option value="expense">รายจ่าย</option>
                        <option value="income">รายรับ</option>
                        <option value="saving">ออมเงิน</option>
                    </select>
                </div>
                <div class="col"><label for="editCat">หมวดหมู่</label><select id="editCat"></select></div>
                <div class="col"><label for="editAmount">จำนวนเงิน (บาท)</label><input id="editAmount" type="number" step="0.01" placeholder="0.00"></div>
                <div class="col" style="flex:1 1 100%"><label for="editNote">หมายเหตุ</label><input id="editNote" maxlength="500" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"></div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="actions">
                <button id="btnDelete" class="btn-danger">ลบ</button>
                <button id="btnCancel" style="background:transparent; border:1px solid var(--line); color: var(--text-secondary);">ยกเลิก</button>
                <button id="btnUpdate" class="btn-green">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
        <div class="modal-header"><div id="confirmTitle" class="title">ยืนยัน</div></div>
        <div class="modal-body"><div id="confirmMsg" style="color:var(--text-secondary);">คุณต้องการทำรายการนี้หรือไม่?</div></div>
        <div class="modal-footer">
            <div class="actions">
                <button id="btnNo" style="background:transparent; border:1px solid var(--line); color: var(--text-secondary);">ยกเลิก</button>
                <button id="btnYes" class="btn-danger">ยืนยัน</button>
            </div>
        </div>
    </div>
</div>


<div id="toast" style="position:fixed; left:50%; bottom:calc(90px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%); background:#333; color:#fff; padding:.75rem 1.2rem; border-radius:14px; opacity:0; transition:.35s; pointer-events:none; z-index:100; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">แจ้งเตือน</div>
<div id="overlay"><div class="spinner" aria-hidden="true"></div></div>

<script>
    /* ===== CONFIG ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbznJMWIaEVx9NQurW2PO38SUQPSRoYFzSmhZCjNUIDJEFRLv1JmDC2XsQCoBUIlAbm8Uw/exec';
    const BUD_CAT_OVERALL      = '__BUDGET_OVERALL__';
    const BUD_CAT_SAVE_GOAL = '__SAVING_GOAL__';

    /* ===== STATE ===== */
    let token = localStorage.getItem('fin_token') || '';
    let displayName = localStorage.getItem('fin_name') || '';
    let lastItems = [];
    let withdrawIncomeIds = new Set();
    let debtsCache = []; // active debts
    const monthSettingsCache = {}; // { 'YYYY-MM': {budget, goal} }

    /* ===== HELPERS ===== */
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmt = n => Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
    const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    function toast(msg, ok=true){ const el=$('#toast'); el.textContent=msg; el.style.background=ok? 'var(--green-color)' : 'var(--red-color)'; el.style.color='#fff'; el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',2400); }
    const showOverlay = (on)=> $('#overlay').classList.toggle('show', !!on);
    const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    function todayISO(){ return toYMD(new Date()); }
    function monthBoundsOf(d){ return { start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) }; }
    function monthKeyNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function monthKeyFromRange(){ const f=$('#fFrom').value; if(!f) return monthKeyNow(); return f.slice(0,7); }
    const sum = (arr, pick) => arr.reduce((s,x)=> s+(pick(x)||0), 0);
    const groupBy = (arr, key) => arr.reduce((a,x)=> ((a[key(x)] = a[key(x)]||[]).push(x),a),{});
    const runningSum = (arr)=>{ let s=0; return arr.map(v=>(s+=v,s)); };
    const safeKey = (x)=> `${(x.date||'').slice(0,10)}T${(x.time||'00:00:00').slice(0,8)}`;

    function clearAddForm(){
        $('#txDate').value = todayISO();
        setType('expense');
        $('#txAmount').value=''; $('#txNote').value='';
        $('#txInt').value=''; $('#txPrin').value='';
        if ($('#txCat').options.length) $('#txCat').selectedIndex = 0;
        if ($('#txDebt').options.length) $('#txDebt').selectedIndex = 0;
    }

    async function fetchJSON(url, options={}, timeoutMs=20000){
        const controller = new AbortController();
        const id = setTimeout(()=>controller.abort(), timeoutMs);
        try{
            const res = await fetch(url, { ...options, signal: controller.signal });
            const text = await res.text();
            let j; try { j = JSON.parse(text); } catch(e){ return { ok:false, error:'NON_JSON', raw:text }; }
            return j;
        }catch(e){ return { ok:false, error:'NETWORK_ERROR', message:String(e&&e.message||e) }; }
        finally{ clearTimeout(id); }
    }
    async function api(path, payload={}, useToken=true, withOverlay=false){
        const body = { path, payload }; if (useToken && token) body.token = token;
        if (withOverlay) showOverlay(true);
        const isList = /\/list$/.test(path) || path.endsWith('transactions/list');
        try{
            const call = ()=> fetchJSON(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
            let j = await call();
            if ((!j.ok && j.error==='NETWORK_ERROR') && isList) j = await call();
            if (!j.ok && (j.error==='BAD_TOKEN' || j.error==='UNAUTHORIZED' || j.status===401)){
                localStorage.removeItem('fin_token'); token=''; ensureLoginUI(); toast('เซสชันหมดอายุ โปรดเข้าสู่ระบบใหม่', false);
            }
            if (!j.ok && j.error==='NON_JSON'){ toast('เกิดข้อผิดพลาดจากเซิร์ฟเวอร์ (ข้อมูลไม่เป็น JSON)', false); }
            return j;
        }finally{ if (withOverlay) showOverlay(false); }
    }

    /* ===== BUDGETS ===== */
    async function loadMonthSettingsFromAPI(mk){
        const r = await api('budgets/list', { month: mk }, true, false);
        let budget=0, goal=0;
        if (r.ok){
            for (const it of (r.items||[])) {
                const cid = String(it.category_id);
                if (cid === BUD_CAT_OVERALL)   budget = Number(it.limit_amount||0);
                if (cid === BUD_CAT_SAVE_GOAL) goal   = Number(it.limit_amount||0);
            }
        }
        monthSettingsCache[mk] = { budget, goal };
        $('#budgetThisMonth').value = budget ? String(budget) : '';
        $('#savingGoalThisMonth').value = goal ? String(goal) : '';
        return { budget, goal };
    }
    async function saveMonthSettingsToAPI(mk, budget, goal){
        const [r1, r2] = await Promise.all([
            api('budgets/upsert', { month: mk, category_id: BUD_CAT_OVERALL,   limit_amount: Number(budget||0) }, true, true),
            api('budgets/upsert', { month: mk, category_id: BUD_CAT_SAVE_GOAL, limit_amount: Number(goal||0)   }, true, true),
        ]);
        if (r1.ok && r2.ok){
            monthSettingsCache[mk] = { budget:Number(budget||0), goal:Number(goal||0) };
            $('#budgetThisMonth').value = budget ? String(budget) : '';
            $('#savingGoalThisMonth').value = goal ? String(goal) : '';
            return true;
        }
        return false;
    }

    /* ===== LOGIN & TABS ===== */
    function switchTab(name){
        $$('.nav-btn').forEach(b=>{
            const on = (b.dataset.tab===name);
            b.classList.toggle('active', on);
        });
        $$('.section').forEach(s=>{
            const on = (s.id === 'tab-'+name);
            s.classList.toggle('active', on);
        });
        if (name==='dash'){ ensureRangeDefaults(); refreshDash(); }
        if (name==='list'){ refreshDash(true); }
        if (name==='debt'){ loadDebtsUI(); }
    }
    $$('.nav-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

    function ensureLoginUI(){
        if (token){
            $('#loginBox').classList.add('hide'); $('#app').classList.remove('hide');
            document.querySelector('.bottom-nav').style.display = 'flex';
            $('#who').textContent = displayName || localStorage.getItem('fin_user') || '';
            const initial = (displayName || 'U').charAt(0).toUpperCase();
            $('#userInitial').textContent = initial;

            $('#txDate').value = todayISO();
            ensureRangeDefaults();
            loadCategoriesAll().then(async () => {
                populateCatSelect();
                await loadMonthSettingsFromAPI(monthKeyFromRange());
                await loadDebtsCache();
                fillDebtPickers();
                setTimeout(()=> $('#txAmount')?.focus(), 120);
            });
            refreshDash(true);
        } else {
            $('#loginBox').classList.remove('hide'); $('#app').classList.add('hide');
            document.querySelector('.bottom-nav').style.display = 'none';
        }
    }

    /* LOGIN */
    $('#btnLogin').addEventListener('click', doLogin);
    $('#inpPin').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doLogin(); });
    async function doLogin(){
        const user_id = $('#inpUser').value.trim();
        const pin = $('#inpPin').value.trim();
        if (!user_id || !pin){ $('#loginMsg').textContent='กรุณากรอกข้อมูลให้ครบถ้วน'; return; }
        $('#btnLogin').disabled = true; $('#loginMsg').textContent = 'กำลังเข้าสู่ระบบ...';
        const j = await api('auth/login', { user_id, pin }, false, false);
        $('#btnLogin').disabled = false;
        if (!j.ok){ const msg=(j.error==='USER_NOT_FOUND')?'ไม่พบบัญชีผู้ใช้':(j.error==='BAD_PIN')?'รหัสผ่านผิด':(j.message||'เข้าสู่ระบบไม่สำเร็จ'); $('#loginMsg').textContent=msg; return; }
        token = j.token; displayName = j.display_name || user_id;
        localStorage.setItem('fin_token', token); localStorage.setItem('fin_user', user_id); localStorage.setItem('fin_name', displayName);
        $('#loginMsg').textContent = ''; ensureLoginUI(); switchTab('add');
    }
    $('#btnLogout').addEventListener('click', ()=>{
        localStorage.removeItem('fin_token'); localStorage.removeItem('fin_name'); localStorage.removeItem('fin_user');
        token=''; displayName=''; $('#inpUser').value=''; $('#inpPin').value=''; $('#loginMsg').textContent=''; ensureLoginUI();
    });

    /* ===== CATEGORIES ===== */
    let cats = { income:[], expense:[], saving:[] };
    function _isWithdrawIncomeName(name){ const s = String(name||''); return /ถอน.*ออม|ออม.*ถอน|ถอนออม|ถอนเงินออม|withdraw.*(save|saving)|saving.*withdraw/i.test(s); }
    async function loadCategoriesAll(){
        for (const t of ['income','expense','saving']){
            const r = await api('categories/list', { type:t });
            cats[t] = r.ok ? (r.items||[]) : [];
        }
        withdrawIncomeIds = new Set((cats.income||[]).filter(c=> _isWithdrawIncomeName(c.name_th)).map(c=> c.category_id));
    }
    function populateCatSelect(){
        const t = $('#txType').value; const sel = $('#txCat'); sel.innerHTML='';
        (cats[t]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.category_id; o.textContent=c.name_th; sel.appendChild(o); });
    }
    $('#txType').addEventListener('change', populateCatSelect);

    /* ===== TYPE SWITCH (รวม debt) ===== */
    function setType(type){
        $('#txType').value = type;
        
        // Handle segmented controls
        $$('#tab-add .seg-btn').forEach(el => el.classList.remove('active'));
        if (type === 'expense') $('#btnTypeExp').classList.add('active');
        if (type === 'income') $('#btnTypeInc').classList.add('active');
        if (type === 'saving') $('#btnTypeSav').classList.add('active');
        if (type === 'debt_repay') $('#btnTypeDebtRepay').classList.add('active');
        if (type === 'debt_borrow') $('#btnTypeDebtBorrow').classList.add('active');

        const debtMode = (type==='debt_repay' || type==='debt_borrow');
        $('#colCat').classList.toggle('hide', debtMode);
        $('#colDebt').classList.toggle('hide', !debtMode);

        const isRepay = (type==='debt_repay');
        $('#colDebtRepayFields').classList.toggle('hide', !isRepay);
        $('#colAmount').classList.toggle('hide', isRepay);

        if (!debtMode) { populateCatSelect(); }
        else { fillDebtPickers(); }
    }
    $('#btnTypeExp').addEventListener('click', ()=> setType('expense'));
    $('#btnTypeInc').addEventListener('click', ()=> setType('income'));
    $('#btnTypeSav').addEventListener('click', ()=> setType('saving'));
    $('#btnTypeDebtRepay').addEventListener('click', ()=> setType('debt_repay'));
    $('#btnTypeDebtBorrow').addEventListener('click', ()=> setType('debt_borrow'));


    /* ===== ADD TRANSACTION (รวม debt) ===== */
    function normalizeAmount(v){ const n=Number(v); if (!isFinite(n) || n<=0) return NaN; return Math.round(n*100)/100; }
    async function saveTx(){
        const type = $('#txType').value;
        const date = $('#txDate').value;
        const note = $('#txNote').value.trim();
        if (!date){ toast('กรุณาเลือกวันที่', false); return; }

        $('#btnSave').disabled = true;

        if (type==='debt_repay' || type==='debt_borrow'){
            const debt_id = $('#txDebt').value;
            if (!debt_id){ toast('กรุณาเลือกเจ้าหนี้', false); $('#btnSave').disabled=false; return; }

            if (type==='debt_repay'){
                const interest = Number($('#txInt').value||0);
                const principal = Number($('#txPrin').value||0);
                const amount = Math.round((interest + principal) * 100) / 100;
                if (!(isFinite(amount) && amount>0)){ toast('ใส่ยอดจ่ายดอก/จ่ายต้นให้ถูกต้อง', false); $('#btnSave').disabled=false; return; }
                const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
                $('#btnSave').disabled = false;
                if (r.ok){
                    toast('บันทึกจ่ายหนี้สำเร็จ');
                    clearAddForm();
                    await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
                } else { toast(r.message||'บันทึกไม่สำเร็จ', false); }
                return;
            } else {
                const amount = normalizeAmount($('#txAmount').value);
                if (isNaN(amount)){ toast('จำนวนเงินไม่ถูกต้อง', false); $('#btnSave').disabled=false; return; }
                const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
                $('#btnSave').disabled = false;
                if (r.ok){
                    toast('บันทึกกู้หนี้สำเร็จ');
                    clearAddForm();
                    await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
                } else { toast(r.message||'บันทึกไม่สำเร็จ', false); }
                return;
            }
        }

        const amount = normalizeAmount($('#txAmount').value);
        const category_id = $('#txCat').value;
        if (isNaN(amount)){ toast('จำนวนเงินไม่ถูกต้อง', false); $('#btnSave').disabled=false; return; }
        if (!category_id){ toast('กรุณาเลือกหมวด', false); $('#btnSave').disabled=false; return; }

        const payload = { date, type, category_id, amount, note };
        const r = await api('transactions/create', payload, true, true);
        $('#btnSave').disabled = false;
        if (r.ok){
            toast('บันทึกสำเร็จ');
            clearAddForm();
            refreshDash(true); $('#txAmount').focus();
        } else {
            toast('บันทึกไม่สำเร็จ', false);
        }
    }
    $('#btnSave').addEventListener('click', ()=> saveTx());
    $('#tab-add').addEventListener('keydown', (e)=>{ if (e.key==='Enter' && e.target.tagName !== 'BUTTON'){ e.preventDefault(); saveTx(); } });

    /* ===== DASHBOARD ===== */
    let chartExp=null, chartFlow=null;
    function setKpiLoading(on){
        ['sumIncome','sumExpense','sumSaving','sumNet','sumDebt'].forEach(id=>{
            const el=$('#'+id);
            if(el) {
                if (on){ el.classList.add('skeleton'); el.textContent=''; }
                else   { el.classList.remove('skeleton'); }
            }
        });
    }
    function colorizeNetCard(netVal){ 
        // No longer coloring the card, as it's the header now
    }
    function setRangeDaysBack(days){
        const now = new Date(); const from = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to = toYMD(now);
        $('#fFrom').value = from; $('#fTo').value = to; onRangeChange();
    }
    $('#btnToday').addEventListener('click', ()=>{ const d=todayISO(); $('#fFrom').value=d; $('#fTo').value=d; onRangeChange(); });
    $('#btn7').addEventListener('click', ()=> setRangeDaysBack(7));
    $('#btn30').addEventListener('click', ()=> setRangeDaysBack(30));
    $('#btnMonth').addEventListener('click', ()=>{ const mb=monthBoundsOf(new Date()); $('#fFrom').value=mb.start; $('#fTo').value=mb.end; onRangeChange(); });
    $('#btnYear').addEventListener('click', ()=>{ const y=new Date().getFullYear(); $('#fFrom').value=`${y}-01-01`; $('#fTo').value=`${y}-12-31`; onRangeChange(); });
    
    $('#btnSaveBudget').addEventListener('click', async ()=>{
        const mk = monthKeyFromRange();
        const ok = await saveMonthSettingsToAPI(mk, $('#budgetThisMonth').value, $('#savingGoalThisMonth').value);
        if (ok){ toast('บันทึกสำเร็จ'); await refreshDash(true); }
        else toast('บันทึกไม่สำเร็จ', false);
    });
    function onRangeChange(){ updateRangeUI(); refreshDash(); }
    $('#fFrom').addEventListener('change', onRangeChange);
    $('#fTo').addEventListener('change', onRangeChange);

    function ensureRangeDefaults(){
        if (!$('#fFrom').value || !$('#fTo').value){
            const now = new Date(); const mb = monthBoundsOf(now);
            $('#fFrom').value = mb.start; $('#fTo').value = mb.end;
        }
        updateRangeUI();
    }
    function updateRangeUI(){
        const f=$('#fFrom').value, t=$('#fTo').value;
        const today=todayISO(); const mb = monthBoundsOf(new Date());
        const now=new Date();
        const last7   = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-6));
        const last30  = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-29));
        const yStart= `${now.getFullYear()}-01-01`, yEnd=`${now.getFullYear()}-12-31`;

        const isToday = (f===today && t===today);
        const is7     = (f===last7  && t===today);
        const is30    = (f===last30 && t===today);
        const isMonth = (f===mb.start && t===mb.end);
        const isYear  = (f===yStart && t===yEnd);
        
        $$('#tab-dash .seg-btn').forEach(b => b.classList.remove('active'));

        if(isToday) $('#btnToday').classList.add('active');
        else if(is7) $('#btn7').classList.add('active');
        else if(is30) $('#btn30').classList.add('active');
        else if(isMonth) $('#btnMonth').classList.add('active');
        else if(isYear) $('#btnYear').classList.add('active');

        let txt='กำหนดเอง';
        if (isToday) txt='วันนี้';
        else if (is7) txt='7 วันล่าสุด';
        else if (is30) txt='30 วันล่าสุด';
        else if (isMonth) txt='เดือนนี้';
        else if (isYear) txt='ปีนี้';
        $('#rangeBadge').textContent = txt;
    }

    /* ===== DEBTS MODULE ===== */
    async function loadDebtsCache(){
        const r = await api('debts/list', {}, true, false);
        debtsCache = r.ok ? (r.items||[]) : [];
        fillDebtPickers();
    }
    function fillDebtPickers(){
        const selects = ['#txDebt'];
        selects.forEach(sel=>{
            const el = $(sel); if (!el) return;
            const keep = el.value;
            el.innerHTML = '';
            (debtsCache||[]).forEach(d=>{
                const o=document.createElement('option');
                o.value=d.debt_id; o.textContent=d.lender_name || d.debt_id;
                el.appendChild(o);
            });
            if (keep) el.value = keep;
        });
    }

    $('#btnAddDebt').addEventListener('click', async ()=>{
        const lender_name = $('#dName').value.trim();
        const annual_rate = Number($('#dRate').value||0);
        const principal_initial = Number($('#dPrincipal').value||0);
        if (!lender_name || !isFinite(annual_rate) || annual_rate<0){ toast('กรอกชื่อและอัตราดอกให้ถูกต้อง', false); return; }
        const payload = { lender_name, annual_rate, principal_initial: isFinite(principal_initial)&&principal_initial>0? principal_initial:0, start_date: todayISO() };
        const r = await api('debts/create', payload, true, true);
        if (r.ok){ toast('เพิ่มเจ้าหนี้สำเร็จ'); $('#dName').value=''; $('#dRate').value=''; $('#dPrincipal').value=''; await loadDebtsUI(); fillDebtPickers(); refreshDash(true); }
        else toast(r.message||'ไม่สำเร็จ', false);
    });

    /* ===== DASHBOARD: refresh & KPIs ===== */
    async function refreshDash(silent){
        if (!token){ if(!silent) toast('ยังไม่พบ token (กรุณาเข้าสู่ระบบก่อน)', false); return; }
        setKpiLoading(true);
        if (!cats.expense.length && !cats.income.length && !cats.saving.length){ await loadCategoriesAll(); }
        await loadDebtsCache();

        const mk = monthKeyFromRange();
        await loadMonthSettingsFromAPI(mk).catch(()=>{});

        const from = $('#fFrom').value, to = $('#fTo').value;
        const [rTx, rDebtSum] = await Promise.all([
            api('transactions/list', { from, to, type:'all' }),
            api('debts/summary', {}, true, false)
        ]);
        if (!rTx.ok){ setKpiLoading(false); if(!silent) toast('โหลดรายการไม่สำเร็จ', false); return; }
        lastItems = (rTx.items||[]).map(x=> ({...x, amount:+x.amount}));

        const inc = sum(lastItems, x=> x.type==='income'? x.amount:0);
        const exp = sum(lastItems, x=> x.type==='expense'? x.amount:0);
        const savDep = sum(lastItems, x=> x.type==='saving'? x.amount:0);
        const savWd  = sum(lastItems, x=> x.type==='income' && withdrawIncomeIds.has(x.category_id) ? x.amount : 0);
        const savNet = savDep - savWd;
        const net    = inc - exp - savDep;

        $('#sumIncome').textContent = fmt(inc);
        $('#sumExpense').textContent = fmt(exp);
        $('#sumSaving').textContent  = fmt(Math.max(0, savNet));
        $('#sumNet').textContent     = fmt(net);
        colorizeNetCard(net);
        $('#sumDebt').textContent = rDebtSum.ok ? fmt(Number(rDebtSum.totals?.total||0)) : '—';
        setKpiLoading(false);

        await updateBudgetUI(exp, Math.max(0,savNet), mk);

        const mapCat = Object.fromEntries((cats.expense.concat(cats.income).concat(cats.saving)).map(c=> [c.category_id, c.name_th]));
        drawExpByCat(lastItems, mapCat);
        drawFlow(lastItems);
        renderTable(lastItems, mapCat);
    }
    async function updateBudgetUI(expenseTotal, savingNet, mk){
        const cache = monthSettingsCache[mk] || { budget:0, goal:0 };
        const b = Number(cache.budget||0), g = Number(cache.goal||0);

        const pct = (!b || b<=0) ? 0 : Math.round((expenseTotal/b)*100);
        $('#budgetUsedPct').textContent = b>0 ? `${pct}%` : '—';
        $('#budgetBar').style.width = (b>0 ? Math.min(pct,100) : 0) + '%';
        $('#budgetBar').style.filter = (pct>=100)? 'saturate(1.5)' : (pct>=80? 'saturate(1.2)' : 'none');

        let bTxt = 'ยังไม่ได้ตั้งงบ';
        if (b>0){
            if (expenseTotal > b) bTxt = `เกินงบ ${fmt(expenseTotal - b)}`;
            else                  bTxt = `เหลืองบ ${fmt(b - expenseTotal)}`;
        }
        $('#budgetStatus').textContent = bTxt;

        const savingClamped = Math.max(0, savingNet);
        const pctSave = (!g || g<=0) ? 0 : Math.round((savingClamped/g)*100);
        $('#savingGoalPct').textContent = g>0 ? `${pctSave}%` : '—';
        $('#savingBar').style.width = (g>0 ? Math.min(pctSave,100) : 0) + '%';

        let sTxt='ยังไม่ได้ตั้งเป้า';
        if (g>0){
            if (savingNet>=g) sTxt = `ถึงเป้าแล้ว (+${fmt(savingNet-g)})`;
            else              sTxt = `ขาดอีก ${fmt(g - savingNet)}`;
        }
        $('#savingGoalStatus').textContent = sTxt;
    }

    /* Charts */
    function drawExpByCat(items, mapCat){
        const panelNo = $('#noDataExp'); if (chartExp) chartExp.destroy();
        const exps = items.filter(x=>x.type==='expense');
        if (!exps.length){ panelNo.classList.remove('hide'); chartExp=null; return; }
        panelNo.classList.add('hide');
        const groupExp = groupBy(exps, x=> mapCat[x.category_id] || 'อื่น ๆ');
        const labels = Object.keys(groupExp);
        const data = labels.map(k=> sum(groupExp[k], x=> x.amount));
        chartExp = new Chart($('#chartExp'), {
            type:'bar',
            data:{ labels, datasets:[{ label:'จำนวน (บาท)', data, backgroundColor:'rgba(124, 58, 237, 0.7)', borderColor:'rgba(124, 58, 237, 1)', borderWidth:1, borderRadius: 8 }] },
            options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }, x: {} }, plugins:{ legend:{ display:false } } }
        });
    }
    function drawFlow(items){
        const panelNo = $('#noDataFlow'); if (chartFlow) chartFlow.destroy();
        if (!items.length){ panelNo.classList.remove('hide'); chartFlow=null; return; }
        panelNo.classList.add('hide');
        const g = groupBy(items, x=> x.date);
        const ds = Object.keys(g).sort();
        const income  = ds.map(d=> sum(g[d], x=> x.type==='income'?  x.amount:0));
        const expense = ds.map(d=> sum(g[d], x=> x.type==='expense'? x.amount:0));
        const savingD = ds.map(d=> sum(g[d], x=> x.type==='saving'?  x.amount:0));
        const netDaily = ds.map((_,i)=> income[i] - expense[i] - savingD[i]);
        const netCumulative = runningSum(netDaily);
        chartFlow = new Chart($('#chartFlow'), {
            type:'line',
            data:{ labels: ds,
                datasets:[
                    { label:'รายรับ', data:income, borderColor:'var(--green-color)', backgroundColor:'rgba(16, 185, 129, .15)', tension:.35, fill:true },
                    { label:'รายจ่าย', data:expense, borderColor:'var(--red-color)', backgroundColor:'rgba(244, 63, 94, .15)', tension:.35, fill:true },
                    { label:'คงเหลือสะสม', data:netCumulative, borderColor:'var(--primary-brand-solid)', backgroundColor:'rgba(124, 58, 237, .15)', tension:.35, fill:false }
                ]
            },
            options:{ responsive:true, maintainAspectRatio:false, animation:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:false } } }
        });
    }

    /* ===== LIST + EDIT ===== */
    function renderTable(items, mapCat){
        const tb = $('#tblBody'); tb.innerHTML='';
        const sorted = items.slice().sort((a,b)=> safeKey(b).localeCompare(safeKey(a)));
        if (!sorted.length){ $('#emptyList').style.display='block'; return; }
        $('#emptyList').style.display='none';
        for (const x of sorted){
            const isWithdrawIncome = (x.type==='income' && withdrawIncomeIds.has(x.category_id));
            const typeTxt = x.type==='income'?(isWithdrawIncome?'ถอนออม':'รายรับ'):(x.type==='saving'?'ออมเงิน':'รายจ่าย');
            const badge = x.type==='income' ? (isWithdrawIncome ? 'badge-sav' : 'badge-inc') : (x.type==='saving' ? 'badge-sav' : 'badge-exp');
            const catName = mapCat[x.category_id] || x.category_name || x.category_id || '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${esc((x.date||'').slice(0,10))}</td>
                <td><span class="badge ${badge}">${typeTxt}</span></td>
                <td>
                    <div>${esc(catName)}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${esc(x.note||'')}</div>
                </td>
                <td class="right">${fmt(x.amount)}</td>
                <td>
                    <button class="btn-ghost" style="padding: 0.5rem 0.8rem; font-size: 0.85rem; background:#fff" data-act="edit" data-id="${esc(x.tx_id||'')}">แก้ไข</button>
                </td>`;
            tb.appendChild(tr);
        }
    }

    $('#tblBody').addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('button[data-act="edit"]');
        if (!btn) return;
        openEditById(btn.getAttribute('data-id'));
    });

    function populateEditCatSelect(){
        const t = $('#editType').value; const sel = $('#editCat'); sel.innerHTML='';
        (cats[t]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.category_id; o.textContent=c.name_th; sel.appendChild(o); });
    }

    async function openEditById(txId){
        if (!txId){ toast('ไม่พบรหัสรายการ', false); return; }
        let it = lastItems.find(x=> String(x.tx_id)===String(txId));
        if (!it){
            showOverlay(true);
            const r = await api('transactions/list', { from: $('#fFrom').value, to: $('#fTo').value, type:'all' });
            showOverlay(false);
            if (!r.ok){ toast('โหลดรายการไม่สำเร็จ', false); return; }
            lastItems = (r.items||[]); it = lastItems.find(x=> String(x.tx_id)===String(txId));
            if (!it){ toast('รายการหายไปแล้ว', false); return; }
        }
        $('#editTxId').value = it.tx_id;
        $('#editDate').value = (it.date||'').slice(0,10);
        $('#editType').value = it.type;
        populateEditCatSelect();
        $('#editCat').value = it.category_id;
        $('#editAmount').value = String(it.amount);
        $('#editNote').value = it.note||'';
        $('#editBackdrop').classList.add('show');
        $('#editBackdrop').setAttribute('aria-hidden','false');
    }

    function closeEdit(){ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); }
    $('#btnCancel').addEventListener('click', closeEdit);
    $('#editType').addEventListener('change', populateEditCatSelect);

    $('#btnUpdate').addEventListener('click', async ()=>{
        const tx_id = $('#editTxId').value;
        const amount = Number($('#editAmount').value);
        if (!tx_id || !isFinite(amount) || amount<=0){ toast('ข้อมูลไม่ครบหรือจำนวนเงินไม่ถูกต้อง', false); return; }
        const payload = { tx_id, date: $('#editDate').value, type: $('#editType').value, category_id: $('#editCat').value, amount: Math.round(amount*100)/100, note: $('#editNote').value.trim() };
        $('#btnUpdate').disabled = true;
        const r = await api('transactions/update', payload, true, true);
        $('#btnUpdate').disabled = false;
        if (r.ok){ toast('บันทึกแก้ไขสำเร็จ'); closeEdit(); refreshDash(true); }
        else toast(r.message||'อัปเดตไม่สำเร็จ', false);
    });

    $('#btnDelete').addEventListener('click', async ()=>{
        $('#confirmMsg').textContent='ยืนยันการลบรายการนี้?';
        $('#confirmBackdrop').classList.add('show'); $('#confirmBackdrop').setAttribute('aria-hidden','false');
        const ok = await new Promise(resolve=>{
            const yes=()=>{ cleanup(); resolve(true); };
            const no =()=>{ cleanup(); resolve(false); };
            const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
                $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
            $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
        });
        if (!ok) return;
        const tx_id = $('#editTxId').value; if (!tx_id) return;
        $('#btnDelete').disabled = true;
        const r = await api('transactions/delete', { tx_id }, true, false);
        $('#btnDelete').disabled = false;
        if (r.ok){  
            toast('ลบสำเร็จ'); 
            closeEdit(); 
            refreshDash(true);  
        } else {    
            toast(r.message||'ลบไม่สำเร็จ', false);
        }
    });

    async function loadDebtsUI(){
        await loadDebtsCache();
        const rSum = await api('debts/summary', {}, true, false);
        const mapById = Object.fromEntries((debtsCache||[]).map(d=> [d.debt_id, d]));
        const tb = $('#tblDebts'); tb.innerHTML='';
        const rows = (rSum.ok ? (rSum.items||[]) : []).map(x=>{
            const d = mapById[x.debt_id] || {};
            const principal = Number(x.principal_current ?? d.principal_current ?? 0);
            const accrued     = Number(x.accrued_interest  ?? d.accrued_interest  ?? 0);
            const rate        = Number(x.annual_rate       ?? d.annual_rate       ?? 0);
            const total_due = (typeof x.total_due === 'number' && Number.isFinite(x.total_due))
                ? x.total_due
                : principal + accrued;
            return {
                debt_id: x.debt_id,
                lender_name: x.lender_name || d.lender_name || '',
                rate, total: total_due
            };
        });
        if (rows.length === 0) {
            tb.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center">ยังไม่มีหนี้ที่เปิดอยู่</td></tr>';
            return;
        }
        for (const r of rows){
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${esc(r.lender_name)}</td>
                <td class="right">${fmt(r.rate)}</td>
                <td class="right"><b>${fmt(r.total)}</b></td>
                <td>
                    <button class="btn-danger" style="padding: 0.5rem 0.8rem; font-size: 0.85rem;" data-dact="close" data-id="${esc(r.debt_id)}">ปิดบัญชี</button>
                </td>`;
            tb.appendChild(tr);
        }
    }
    
    $('#tblDebts').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-dact]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-dact');
        if (act==='close'){
            $('#confirmMsg').textContent = 'ยืนยันการปิดบัญชีหนี้นี้หรือไม่?';
            $('#confirmBackdrop').classList.add('show'); $('#confirmBackdrop').setAttribute('aria-hidden','false');
            const ok = await new Promise(resolve=>{
                const yes=()=>{ cleanup(); resolve(true); }; const no =()=>{ cleanup(); resolve(false); };
                const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
                    $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
                $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
            });
            if (!ok) return;
            const r = await api('debts/close', { debt_id:id }, true, true);
            if (r.ok){ toast('ปิดบัญชีสำเร็จ'); await loadDebtsUI(); refreshDash(true); }
            else toast(r.message||'ปิดบัญชีไม่สำเร็จ', false);
        }
    });

    /* ===== INIT & UI Enhancements ===== */
    function init(){
        setType('expense'); ensureLoginUI();
        document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeEdit(); });
        $('#userInfoToggle').addEventListener('click', () => {
            $('#btnLogout').classList.toggle('hide');
        });
    }

    init();
</script>
</body>
</html>
