<!DOCTYPE html>
<html lang="th">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
Â  <title>FIN-JOD Â· à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸²à¸¢à¸£à¸±à¸šâ€“à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢â€“à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™ + à¸«à¸™à¸µà¹‰</title>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
Â  <style>
Â  Â  *{ box-sizing:border-box }
Â  Â  :root{
Â  Â  Â  --bg-start: #f4f6ff;
Â  Â  Â  --bg-end: #e0e7ff;
Â  Â  Â  --panel-bg: rgba(255, 255, 255, 0.75);
Â  Â  Â  --panel-border: rgba(255, 255, 255, 0.9);
Â  Â  Â  --text: #1f2937;
Â  Â  Â  --text-muted: #6b7280;
Â  Â  Â  --line: #e5e7eb;
Â  Â  Â  --primary-grad: linear-gradient(135deg, #818cf8, #a78bfa);
Â  Â  Â  --primary-color: #818cf8;
Â  Â  Â  --green-grad: linear-gradient(135deg, #4ade80, #34d399);
Â  Â  Â  --green-color: #34d399;
Â  Â  Â  --danger-color: #f87171;
Â  Â  Â  --blue-grad: linear-gradient(135deg, #60a5fa, #38bdf8);
Â  Â  Â  --blue-color: #60a5fa;
Â  Â  Â  --cyan-grad: linear-gradient(135deg, #2dd4bf, #34d399);
Â  Â  Â  --cyan-color: #2dd4bf;
Â  Â  Â  --warning-color: #fbbf24;
Â  Â  }
Â  Â  html,body{ height:100% }
Â  Â  body{
Â  Â  Â  margin:0; padding: clamp(1rem, 3vw, 2rem);
Â  Â  Â  font-family:'Kanit',sans-serif;
Â  Â  Â  background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
Â  Â  Â  color:var(--text);
Â  Â  Â  padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
Â  Â  }
Â  Â  h1{ text-align:center; font-size:clamp(1.5rem,5vw,2.25rem); color:transparent; background: var(--primary-grad); -webkit-background-clip: text; background-clip: text; margin:0 0 1.5rem; font-weight:700; }
Â  Â  .container{ width:min(1140px,100%); margin:auto; }

Â  Â  .app-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
Â  Â  .user-info { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; color: var(--text-muted); font-weight: 600; }
Â  Â  .user-info .icon { font-size: 1.5rem; }

Â  Â  .section{ display:none } .section.active{ display:block }

Â  Â  .row{ display:flex; flex-wrap:wrap; gap:1.25rem; margin-bottom:1.25rem; align-items:flex-start }
Â  Â  .col{ flex:1 1 46%; display:flex; flex-direction:column; gap:.5rem; min-width:220px }
Â  Â  label{ color:var(--text-muted); font-size:.9rem; font-weight: 600; }
Â  Â  input,select,button{
Â  Â  Â  padding: 0.9rem 1.1rem; font-size:16px; border-radius:16px; border: 1px solid var(--line);
Â  Â  Â  background: #fdfdff; color:var(--text); min-height:48px; font-family: 'Kanit', sans-serif;
Â  Â  }
Â  Â  input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.25); outline: none; }
Â  Â  input::placeholder { color: #9ca3af; }
Â  Â  input[type=number]{ text-align:right; -moz-appearance:textfield }
Â  Â  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }

Â  Â  button{
Â  Â  Â  background: var(--primary-grad); border:none; color: #fff; font-weight:700; cursor:pointer;
Â  Â  Â  transition: transform 0.2s, box-shadow 0.2s; touch-action:manipulation;
Â  Â  }
Â  Â  @media (hover:hover) and (pointer:fine){ button:hover{ transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,.1); } }
Â  Â  button:active { transform: translateY(0); }
Â  Â  button:disabled{ opacity:.6; cursor:not-allowed; transform: none; box-shadow: none; }
Â  Â  .btn-ghost{ background:#e5e7eb; color: var(--text-muted); border: 1px solid #d1d5db; }
Â  Â  .btn-ghost.active, .segbtn.active { background: var(--primary-grad); color: #fff; border: none; }
Â  Â  .btn-green{ background:var(--green-grad) }
Â  Â  .btn-blue{ background:var(--blue-grad) }
Â  Â  .btn-danger{ background:var(--danger-color); border: none; color: #fff; }
Â  Â  .btn-cyan{ background:var(--cyan-grad); color:#fff }

Â  Â  .card{
Â  Â  Â  background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 24px;
Â  Â  Â  padding: clamp(1rem, 3vw, 1.5rem); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
Â  Â  Â  box-shadow: 0 8px 32px rgba(107, 114, 128, 0.1);
Â  Â  }
Â  Â  .muted{ color:var(--text-muted) } .right{ text-align:right }
Â  Â  .chart-wrap{ height:260px; width:100%; margin-top: 1rem; } .chart-wrap canvas{ width:100% !important; height:100% !important; display:block }

Â  Â  table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:.95rem }
Â  Â  th,td{ border-bottom:1px solid var(--line); padding:.9rem .6rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
Â  Â  th{ color:var(--text-muted); font-weight:600; text-align:left; position:sticky; top:0; background:var(--panel-bg); z-index:1 }
Â  Â  .table-viewport{ max-height:420px; overflow:auto; border-radius:18px; border:1px solid var(--line); background: rgba(255,255,255,0.4); }
Â  Â  .table-viewport tbody tr:hover{ background: rgba(255,255,255,0.7) }
Â  Â  .badge{ padding:.3rem .75rem; border-radius:999px; font-size:.8rem; font-weight: 600; }
Â  Â  .badge-inc{ background-color: #dcfce7; color: #166534; }
Â  Â  .badge-exp{ background-color: #fee2e2; color: #991b1b; }
Â  Â  .badge-sav{ background-color: #ccfbf1; color: #0f766e; }
Â  Â  .badge-debt{ background-color: #dbeafe; color: #1e40af; }

Â  Â  #toast{ position:fixed; left:50%; bottom:calc(100px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%); background:#333; color:#fff; padding:.75rem 1.2rem; border-radius:14px; opacity:0; transition:.35s; pointer-events:none; z-index:100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
Â  Â  .hide{ display:none !important }
Â  Â  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:99; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
Â  Â  #overlay.show{ display:flex }
Â  Â  .spinner{ width:58px; height:58px; border:6px solid rgba(255,255,255,.45); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite }
Â  Â  @keyframes spin{ to{ transform:rotate(360deg) } }
Â  Â  .skeleton{ position:relative; overflow:hidden; background:#e5e7eb; border-radius:8px; min-height:20px }
Â  Â  .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent); animation:skeleton 1.2s infinite }
Â  Â  @keyframes skeleton{ 100%{ transform:translateX(100%) } }

Â  Â  .bar-track{ height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden }
Â  Â  .bar-fill{ height:100%; width:0% }
Â  Â  #budgetBar{ background:linear-gradient(90deg, #60a5fa, #fbbf24, #f87171) }
Â  Â  #savingBar{ background:linear-gradient(90deg, #2dd4bf, #34d399) }

Â  Â  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.3); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:60 }
Â  Â  .modal-backdrop.show{ display:flex }
Â  Â  .modal{ width:min(640px,96vw); background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:20px; padding:1.5rem; box-shadow:0 20px 60px rgba(0,0,0,.2) }
Â  Â  .modal .title{ font-weight:700; margin-bottom:1rem; font-size: 1.25rem; color: var(--text) }
Â  Â  .modal .actions{ display:flex; gap:.75rem; justify-content:flex-end; margin-top:1.5rem }

Â  Â  .kpi{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1rem; }
Â  Â  .kpi .card{ display:flex; flex-direction:column; gap:.35rem; min-height:92px; transition: transform .2s; }
Â  Â  .kpi .card:hover { transform: translateY(-4px); }
Â  Â  .kpi .card .muted { font-weight: 600; }
Â  Â  #kpiWrap .card:nth-child(1) { background-image: linear-gradient(135deg, #e0f2fe, #dbeafe); }
Â  Â  #kpiWrap .card:nth-child(2) { background-image: linear-gradient(135deg, #fee2e2, #ffedd5); }
Â  Â  #kpiWrap .card:nth-child(3) { background-image: linear-gradient(135deg, #dcfce7, #ccfbf1); }
Â  Â  #kpiWrap .card:nth-child(4) { background-image: linear-gradient(135deg, #eef2ff, #f5f3ff); }
Â  Â  #kpiWrap .card:nth-child(5) { background-image: linear-gradient(135deg, #ede9fe, #dbeafe); }

Â  Â  #pop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:130; background:transparent }
Â  Â  #pop.show{ display:flex; }
Â  Â  .pop-box{ display:flex; align-items:center; gap:.6rem; background: #fff; border:1px solid var(--green-color); border-radius:14px; padding:.9rem 1.1rem; box-shadow:0 16px 40px rgba(0,0,0,.2) }
Â  Â  .pop-icon{ width:26px; height:26px; border-radius:50%; background:var(--green-color); color:#fff; font-weight:900; display:flex; align-items:center; justify-content:center }
Â  Â  .pop-msg{ font-weight:700; color: var(--text); }
    
     /* === Bottom Nav Bar === */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: calc(70px + env(safe-area-inset-bottom, 0px));
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-top: 1px solid rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        padding-top: 8px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        z-index: 50;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    }
    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        color: var(--text-muted);
        background: none;
        border: none;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-family: 'Kanit', sans-serif;
        cursor: pointer;
        transition: color 0.2s, transform 0.2s;
        flex: 1;
        min-height: 56px;
    }
    .nav-btn:hover { color: var(--primary-color); transform: none; box-shadow: none; }
    .nav-btn.active { color: var(--primary-color); font-weight: 700; }
    .nav-btn svg {
        width: 24px;
        height: 24px;
        stroke-width: 2;
        transition: transform 0.2s;
    }
    .nav-btn.active svg { transform: scale(1.1); }

Â  Â  @media(max-width:980px){ .chart-wrap{ height:220px } }
Â  Â  @media(max-width:768px){
Â  Â  Â  .col{ flex:1 1 100% } .chart-wrap{ height:200px }
Â  Â  Â  .table-viewport{ max-height:none; overflow-y:visible; overflow-x:auto; -webkit-overflow-scrolling:touch; }
Â  Â  Â  th{ position:static } table{ min-width:720px; table-layout:auto }
Â  Â  }
Â  Â  #tblDebts td:last-child { overflow: visible; }
Â  Â  #tblDebts td:last-child .actions { display:flex; gap:.5rem; }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <h1>FIN-JOD</h1>

Â  Â  Â  Â  <div id="loginBox" class="card">
      <h2 style="text-align: center; margin-top: 0; color: var(--text);">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</h2>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  <label for="inpUser">User ID</label>
Â  Â  Â  Â  Â  <input id="inpUser" placeholder="à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™" autocomplete="username"/>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  <label for="inpPin">PIN</label>
Â  Â  Â  Â  Â  <input id="inpPin" type="password" placeholder="à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™" autocomplete="current-password"/>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <button id="btnLogin" class="btn-green" style="width: 100%;">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
Â  Â  Â  Â  <span id="loginMsg" class="muted" style="align-self:center"></span>
Â  Â  Â  </div>
Â  Â  Â  <div class="muted" style="margin-top:.25rem; font-size: 0.85rem; text-align: center;">* à¸•à¸´à¸”à¸•à¹ˆà¸­à¸à¸µà¹ˆà¹€à¸¥à¸µà¹‰à¸¢à¸‡à¹€à¸à¸·à¹ˆà¸­à¸£à¸±à¸š User ID à¹à¸¥à¸° Password</div>
Â  Â  </div>

Â  Â  Â  Â  <div id="app" class="hide">
Â  Â  Â  <div class="app-header">
        <div class="user-info">
            <span class="icon">ğŸ‘¤</span> <span id="who"></span>
        </div>
Â  Â  Â  Â  <button id="btnLogout" class="btn-ghost">à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <section id="tab-add" class="section active card">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label for="txDate">à¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
Â  Â  Â  Â  Â  Â  <input id="txDate" type="date" />
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>à¸›à¸£à¸°à¹€à¸ à¸—</label>
Â  Â  Â  Â  Â  Â  <div class="row" style="gap:.5rem; margin:0; flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  Â  <button id="btnTypeExp" class="btn-ghost" aria-pressed="true">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</button>
Â  Â  Â  Â  Â  Â  Â  <button id="btnTypeInc" class="btn-ghost" aria-pressed="false">à¸£à¸²à¸¢à¸£à¸±à¸š</button>
Â  Â  Â  Â  Â  Â  Â  <button id="btnTypeSav" class="btn-ghost" aria-pressed="false">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™</button>
Â  Â  Â  Â  Â  Â  Â  <span class="muted" style="align-self:center">|</span>
Â  Â  Â  Â  Â  Â  Â  <button id="btnTypeDebtRepay"Â  class="btn-ghost" aria-pressed="false" title="à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰">à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰</button>
Â  Â  Â  Â  Â  Â  Â  <button id="btnTypeDebtBorrow" class="btn-ghost" aria-pressed="false" title="à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰">à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="txType" class="hide" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  <option value="expense" selected>à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</option>
Â  Â  Â  Â  Â  Â  Â  <option value="income">à¸£à¸²à¸¢à¸£à¸±à¸š</option>
Â  Â  Â  Â  Â  Â  Â  <option value="saving">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™</option>
Â  Â  Â  Â  Â  Â  Â  <option value="debt_repay">à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰</option>
Â  Â  Â  Â  Â  Â  Â  <option value="debt_borrow">à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col" id="colCat">
Â  Â  Â  Â  Â  Â  <label for="txCat">à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ</label>
Â  Â  Â  Â  Â  Â  <select id="txCat"></select>
Â  Â  Â  Â  Â  Â  <div class="row" style="gap:.5rem; margin:.5rem 0 0">
Â  Â  Â  Â  Â  Â  Â  <button id="btnAddCatInline" class="btn-blue" style="min-width:140px">+ à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”à¹ƒà¸«à¸¡à¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="muted" style="font-size:.9rem">* à¹€à¸à¸´à¹ˆà¸¡à¹€à¸‰à¸à¸²à¸°à¸à¸£à¸“à¸µà¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¡à¸§à¸”à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="col hide" id="colDebt">
Â  Â  Â  Â  Â  Â  <label for="txDebt">à¹€à¸¥à¸·à¸­à¸à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</label>
Â  Â  Â  Â  Â  Â  <select id="txDebt"></select>
Â  Â  Â  Â  Â  Â  <div class="muted" style="font-size:.9rem">* à¸£à¸²à¸¢à¸à¸²à¸£à¸ˆà¸²à¸à¹à¸—à¹‡à¸š â€œà¸«à¸™à¸µà¹‰â€</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col hide" id="colDebtRepayFields">
Â  Â  Â  Â  Â  Â  <label>à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰</label>
Â  Â  Â  Â  Â  Â  <div class="row" style="gap:.5rem; margin:0">
Â  Â  Â  Â  Â  Â  Â  <div class="col"><input id="txInt" type="number" step="0.01" placeholder="à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸ (à¸šà¸²à¸—)"></div>
Â  Â  Â  Â  Â  Â  Â  <div class="col"><input id="txPrin" type="number" step="0.01" placeholder="à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™ (à¸šà¸²à¸—)"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="muted" style="font-size:.9rem">* à¸£à¸°à¸šà¸šà¸ˆà¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸¢à¸­à¸”à¸£à¸§à¸¡ = à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸ + à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="col" id="colAmount">
Â  Â  Â  Â  Â  Â  <label for="txAmount">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—)</label>
Â  Â  Â  Â  Â  Â  <input id="txAmount" type="number" step="0.01" placeholder="0.00" inputmode="decimal">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row save-row" style="align-items:flex-end; gap:1rem">
Â  Â  Â  Â  Â  <div class="col" style="flex:1 1 0">
Â  Â  Â  Â  Â  Â  <label for="txNote">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label>
Â  Â  Â  Â  Â  Â  <input id="txNote" placeholder="à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ (à¸–à¹‰à¸²à¸¡à¸µ)" maxlength="500">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col" style="flex:0 0 auto">
Â  Â  Â  Â  Â  Â  <button id="btnSave" class="btn-green" style="min-width:180px">à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸²à¸¢à¸à¸²à¸£</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card quickadd hide" style="margin-top: 1.5rem;">
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸šà¸±à¸™à¸—à¸¶à¸à¸”à¹ˆà¸§à¸™</div>
Â  Â  Â  Â  Â  <div class="quick-wrap" id="quickWrap"></div>
Â  Â  Â  Â  Â  <div class="row" style="margin-top:.5rem">
Â  Â  Â  Â  Â  Â  <div class="col"><input id="qaLabel" placeholder="à¹€à¸Šà¹ˆà¸™ à¸à¸²à¹à¸Ÿ" /></div>
Â  Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  Â  <select id="qaType">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="expense">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="income">à¸£à¸²à¸¢à¸£à¸±à¸š</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="saving">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col"><input id="qaAmount" type="number" step="0.01" placeholder="à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™" /></div>
Â  Â  Â  Â  Â  Â  <div class="col"><button class="btn-blue" id="btnAddQA">+ à¹€à¸à¸´à¹ˆà¸¡ Quick Add</button></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-debt" class="section card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card" style="margin-bottom:1rem">
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¹€à¸à¸´à¹ˆà¸¡à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dName">à¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</label><input id="dName" placeholder="à¹€à¸Šà¹ˆà¸™ à¸šà¸±à¸•à¸£ X / à¹€à¸à¸·à¹ˆà¸­à¸™ A"></div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dRate">à¸­à¸±à¸•à¸£à¸²à¸”à¸­à¸à¹€à¸šà¸µà¹‰à¸¢à¸•à¹ˆà¸­à¸›à¸µ (%)</label><input id="dRate" type="number" step="0.01" placeholder="à¹€à¸Šà¹ˆà¸™ 18"></div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dPrincipal">à¸¢à¸­à¸”à¸•à¸±à¹‰à¸‡à¸•à¹‰à¸™ (à¹„à¸¡à¹ˆà¸šà¸±à¸‡à¸„à¸±à¸š)</label><input id="dPrincipal" type="number" step="0.01" placeholder="à¹€à¸Šà¹ˆà¸™ 10000"></div>
Â  Â  Â  Â  Â  Â  <div class="col" style="align-self:flex-end"><button id="btnAddDebt" class="btn-blue">+ à¹€à¸à¸´à¹ˆà¸¡à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</button></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card" style="margin-bottom:1rem">
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸šà¸±à¸™à¸—à¸¶à¸à¸«à¸™à¸µà¹‰à¸”à¹ˆà¸§à¸™</div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dqType">à¸›à¸£à¸°à¹€à¸ à¸—</label>
Â  Â  Â  Â  Â  Â  Â  <select id="dqType">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="repay">à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="borrow">à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dqDebt">à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</label><select id="dqDebt"></select></div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dqDate">à¸§à¸±à¸™à¸—à¸µà¹ˆ</label><input id="dqDate" type="date"></div>

Â  Â  Â  Â  Â  Â  <div class="col" id="dqColRepay1"><label for="dqInt">à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸ (à¸šà¸²à¸—)</label><input id="dqInt" type="number" step="0.01" placeholder="0.00"></div>
Â  Â  Â  Â  Â  Â  <div class="col" id="dqColRepay2"><label for="dqPrin">à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™ (à¸šà¸²à¸—)</label><input id="dqPrin" type="number" step="0.01" placeholder="0.00"></div>

Â  Â  Â  Â  Â  Â  <div class="col hide" id="dqColAmount"><label for="dqAmount">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—)</label><input id="dqAmount" type="number" step="0.01" placeholder="0.00"></div>

Â  Â  Â  Â  Â  Â  <div class="col" style="flex:1 1 100%"><label for="dqNote">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label><input id="dqNote" placeholder="à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” (à¸–à¹‰à¸²à¸¡à¸µ)"></div>
Â  Â  Â  Â  Â  Â  <div class="col" style="align-self:flex-end"><button id="btnDebtQuick" class="btn-green">à¸šà¸±à¸™à¸—à¸¶à¸</button></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card" style="margin-bottom:1rem">
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰ (à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹€à¸›à¸´à¸”à¸­à¸¢à¸¹à¹ˆ)</div>
Â  Â  Â  Â  Â  <div class="table-viewport">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:200px">à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:110px" class="right">% à¸•à¹ˆà¸­à¸›à¸µ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:140px" class="right">à¹€à¸‡à¸´à¸™à¸•à¹‰à¸™</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:140px" class="right">à¸”à¸­à¸à¸„à¹‰à¸²à¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:140px" class="right">à¸£à¸§à¸¡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸ˆà¹ˆà¸²à¸¢</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:130px">à¸­à¸±à¸›à¹€à¸”à¸•à¸–à¸¶à¸‡</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:200px">à¸ˆà¸±à¸”à¸à¸²à¸£</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="tblDebts"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-top:.5rem">* à¸«à¸™à¸µà¹‰à¸—à¸µà¹ˆà¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µà¹à¸¥à¹‰à¸§à¸”à¸¹à¹„à¸”à¹‰à¹ƒà¸™ â€œà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸˜à¸¸à¸£à¸à¸£à¸£à¸¡à¸«à¸™à¸µà¹‰â€ à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="row" style="margin-bottom:.25rem">
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dtFrom">à¸ˆà¸²à¸</label><input id="dtFrom" type="date"></div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dtTo">à¸–à¸¶à¸‡</label><input id="dtTo" type="date"></div>
Â  Â  Â  Â  Â  Â  <div class="col"><label for="dtDebt">à¸à¸£à¸­à¸‡à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</label><select id="dtDebt"><option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option></select></div>
Â  Â  Â  Â  Â  Â  <div class="col" style="align-self:flex-end"><button id="btnLoadDebtTx" class="btn-blue">à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸›à¸£à¸°à¸§à¸±à¸•à¸´</button></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="table-viewport">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:110px">à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:120px">à¸›à¸£à¸°à¹€à¸ à¸—</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="right" style="width:120px">à¸¢à¸­à¸”</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="right" style="width:120px">à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="right" style="width:120px">à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="right" style="width:110px">à¸ˆà¹ˆà¸²à¸¢à¹€à¸à¸´à¸™</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="tblDebtTx"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-dash" class="section card">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="col"><label for="fFrom">à¸ˆà¸²à¸</label><input id="fFrom" type="date"></div>
Â  Â  Â  Â  Â  <div class="col"><label for="fTo">à¸–à¸¶à¸‡</label><input id="fTo" type="date"></div>
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>&nbsp;</label>
Â  Â  Â  Â  Â  Â  <div class="row" style="gap:.5rem; margin:0">
Â  Â  Â  Â  Â  Â  Â  <button class="segbtn btn-ghost" id="btnToday">à¸§à¸±à¸™à¸™à¸µà¹‰</button>
Â  Â  Â  Â  Â  Â  Â  <button class="segbtn btn-ghost" id="btn7">7 à¸§à¸±à¸™</button>
Â  Â  Â  Â  Â  Â  Â  <button class="segbtn btn-ghost" id="btn30">30 à¸§à¸±à¸™</button>
Â  Â  Â  Â  Â  Â  Â  <button class="segbtn btn-ghost" id="btnMonth">à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</button>
Â  Â  Â  Â  Â  Â  Â  <button class="segbtn btn-ghost" id="btnYear">à¸›à¸µà¸™à¸µà¹‰</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn-blue"Â  id="btnRefresh">à¸£à¸µà¹€à¸Ÿà¸£à¸Š</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:.5rem"><span class="badge badge-debt">à¸à¸³à¸¥à¸±à¸‡à¸”à¸¹: <span id="rangeBadge">à¸à¸³à¸«à¸™à¸”à¹€à¸­à¸‡</span></span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="card" style="margin-bottom:1rem">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  Â  <label for="budgetThisMonth">à¸‡à¸šà¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰ (à¸šà¸²à¸—)</label>
Â  Â  Â  Â  Â  Â  Â  <input id="budgetThisMonth" type="number" min="0" step="0.01" placeholder="à¹€à¸Šà¹ˆà¸™ 10000">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  Â  <label for="savingGoalThisMonth">à¹€à¸›à¹‰à¸²à¸­à¸­à¸¡à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰ (à¸šà¸²à¸—)</label>
Â  Â  Â  Â  Â  Â  Â  <input id="savingGoalThisMonth" type="number" min="0" step="0.01" placeholder="à¹€à¸Šà¹ˆà¸™ 1500">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col" style="align-self:flex-end"><button id="btnSaveBudget" class="btn-blue">à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸š/à¹€à¸›à¹‰à¸²à¸­à¸­à¸¡</button></div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="inline-status muted">
Â  Â  Â  Â  Â  Â  <span>à¹ƒà¸Šà¹‰à¹„à¸›: <b id="budgetUsedPct" style="color:var(--text)">â€”</b></span><span class="sep"> | </span><span id="budgetStatus">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰: â€”</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="bar-track"><div id="budgetBar" class="bar-fill"></div></div>

Â  Â  Â  Â  Â  <div class="inline-status muted" style="margin-top:.6rem">
Â  Â  Â  Â  Â  Â  <span>à¸­à¸­à¸¡à¹à¸¥à¹‰à¸§: <b id="savingGoalPct" style="color:var(--text)">â€”</b></span><span class="sep"> | </span><span>à¸ªà¸–à¸²à¸™à¸°à¸­à¸­à¸¡à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰: <b id="savingGoalStatus" style="color:var(--text)">â€”</b></span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="bar-track"><div id="savingBar" class="bar-fill"></div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi" id="kpiWrap">
Â  Â  Â  Â  Â  <div class="card"><div class="muted">à¸£à¸²à¸¢à¸£à¸±à¸šà¸£à¸§à¸¡ (à¸šà¸²à¸—)</div><div id="sumIncome"Â  style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
Â  Â  Â  Â  Â  <div class="card"><div class="muted">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸£à¸§à¸¡ (à¸šà¸²à¸—)</div><div id="sumExpense" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
Â  Â  Â  Â  Â  <div class="card"><div class="muted">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™à¸ªà¸¸à¸—à¸˜à¸´ (à¸šà¸²à¸—)</div><div id="sumSaving" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
Â  Â  Â  Â  Â  <div class="card" id="netCard"><div class="muted">à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­ (à¸šà¸²à¸—)</div><div id="sumNet"Â  Â  style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
Â  Â  Â  Â  Â  <div class="card"><div class="muted">à¸¢à¸­à¸”à¸«à¸™à¸µà¹‰à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸£à¸§à¸¡ (à¸šà¸²à¸—)</div><div id="sumDebt" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="card" style="flex:1 1 48%">
Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¸•à¸²à¸¡à¸«à¸¡à¸§à¸”</div>
Â  Â  Â  Â  Â  Â  <div id="noDataExp" class="muted hide">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="chartExp"></canvas></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card" style="flex:1 1 48%">
Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸à¸£à¸°à¹à¸ªà¹€à¸‡à¸´à¸™à¸ªà¸” (à¸£à¸²à¸¢à¸§à¸±à¸™ & à¸ªà¸°à¸ªà¸¡)</div>
Â  Â  Â  Â  Â  Â  <div id="noDataFlow" class="muted hide">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="chartFlow"></canvas></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="card" style="flex:1 1 48%">
Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸«à¸™à¸µà¹‰à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸£à¸§à¸¡ (à¸ˆà¸³à¸¥à¸­à¸‡à¸£à¸²à¸¢à¸§à¸±à¸™)</div>
Â  Â  Â  Â  Â  Â  <div id="noDataDebtTS" class="muted hide">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸™à¸µà¹‰à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="chartDebtTS"></canvas></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card" style="flex:1 1 48%">
Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™ vs à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸ (à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™)</div>
Â  Â  Â  Â  Â  Â  <div id="noDataPI" class="muted hide">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸˜à¸¸à¸£à¸à¸£à¸£à¸¡à¸«à¸™à¸µà¹‰à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="chartPI"></canvas></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="card" style="flex:1 1 100%">
Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™à¸ªà¸°à¸ªà¸¡ (à¸à¸²à¸ âˆ’ à¸–à¸­à¸™)</div>
Â  Â  Â  Â  Â  Â  <div id="noDataSav" class="muted hide">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div>
Â  Â  Â  Â  Â  Â  <div class="chart-wrap"><canvas id="chartSavCum"></canvas></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="tab-list" class="section card">
Â  Â  Â  Â  <div class="muted" style="margin-bottom:.5rem">à¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ (à¸ˆà¸²à¸à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”)</div>
Â  Â  Â  Â  <div class="table-viewport">
Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead><tr>
Â  Â  Â  Â  Â  Â  Â  <th style="width:110px">à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width:160px">à¸›à¸£à¸°à¹€à¸ à¸—</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸«à¸¡à¸§à¸”</th>
Â  Â  Â  Â  Â  Â  Â  <th class="right" style="width:130px">à¸ˆà¸³à¸™à¸§à¸™</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th>
Â  Â  Â  Â  Â  Â  Â  <th style="width:92px">à¸ˆà¸±à¸”à¸à¸²à¸£</th>
Â  Â  Â  Â  Â  Â  </tr></thead>
Â  Â  Â  Â  Â  Â  <tbody id="tblBody"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="emptyList" class="muted" style="margin-top:.5rem; display:none">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</div>
Â  Â  Â  </section>
Â  Â  </div>
Â  </div>
  
  <nav class="bottom-nav">
      <button class="nav-btn active" data-tab="add">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
          <span>à¸šà¸±à¸™à¸—à¸¶à¸</span>
      </button>
      <button class="nav-btn" data-tab="debt">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" /></svg>
          <span>à¸«à¸™à¸µà¹‰</span>
      </button>
      <button class="nav-btn" data-tab="dash">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-12a2.25 2.25 0 01-2.25-2.25V3M3.75 21v-6.167c0-.621.504-1.125 1.125-1.125h12.75c.621 0 1.125.504 1.125 1.125V21M3.75 21h16.5M12 6.75v3.75m0 0l-1.5-1.5m1.5 1.5l1.5-1.5" /></svg>
          <span>à¸ à¸²à¸à¸£à¸§à¸¡</span>
      </button>
      <button class="nav-btn" data-tab="list">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
          <span>à¸£à¸²à¸¢à¸à¸²à¸£</span>
      </button>
  </nav>

Â  Â  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
Â  Â  Â  <div id="editTitle" class="title">à¹à¸à¹‰à¹„à¸‚à¸£à¸²à¸¢à¸à¸²à¸£</div>
Â  Â  Â  <input id="editTxId" type="hidden">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="col"><label for="editDate">à¸§à¸±à¸™à¸—à¸µà¹ˆ</label><input id="editDate" type="date"></div>
Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  <label for="editType">à¸›à¸£à¸°à¹€à¸ à¸—</label>
Â  Â  Â  Â  Â  <select id="editType">
Â  Â  Â  Â  Â  Â  <option value="expense">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</option>
Â  Â  Â  Â  Â  Â  <option value="income">à¸£à¸²à¸¢à¸£à¸±à¸š</option>
Â  Â  Â  Â  Â  Â  <option value="saving">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col"><label for="editCat">à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ</label><select id="editCat"></select></div>
Â  Â  Â  Â  <div class="col"><label for="editAmount">à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ (à¸šà¸²à¸—)</label><input id="editAmount" type="number" step="0.01" placeholder="0.00"></div>
Â  Â  Â  Â  <div class="col" style="flex:1 1 100%"><label for="editNote">à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</label><input id="editNote" maxlength="500" placeholder="à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ (à¸–à¹‰à¸²à¸¡à¸µ)"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btnDelete" class="btn-danger">à¸¥à¸š</button>
Â  Â  Â  Â  <button id="btnCancel" class="btn-ghost">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button id="btnUpdate" class="btn-green">à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="confirmBackdrop" class="modal-backdrop" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
Â  Â  Â  <div id="confirmTitle" class="title">à¸¢à¸·à¸™à¸¢à¸±à¸™</div>
Â  Â  Â  <div id="confirmMsg" class="muted" style="margin-bottom:.75rem">à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸—à¸³à¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?</div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btnNo" class="btn-ghost">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button id="btnYes" class="btn-danger">à¸¢à¸·à¸™à¸¢à¸±à¸™</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="addCatBackdrop" class="modal-backdrop" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addCatTitle">
Â  Â  Â  <div id="addCatTitle" class="title">à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”à¹ƒà¸«à¸¡à¹ˆ</div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="col"><label for="addCatType">à¸›à¸£à¸°à¹€à¸ à¸—</label>
Â  Â  Â  Â  Â  <select id="addCatType">
Â  Â  Â  Â  Â  Â  <option value="expense">à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢</option>
Â  Â  Â  Â  Â  Â  <option value="income">à¸£à¸²à¸¢à¸£à¸±à¸š</option>
Â  Â  Â  Â  Â  Â  <option value="saving">à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="col" style="flex:1 1 100%"><label for="addCatName">à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸§à¸”</label><input id="addCatName" placeholder="à¹€à¸Šà¹ˆà¸™ à¸­à¸²à¸«à¸²à¸£/à¸à¸²à¹à¸Ÿ" maxlength="50"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btnAddCatCancel" class="btn-ghost">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button id="btnAddCatSave" class="btn-blue">+ à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="editDebtBackdrop" class="modal-backdrop" aria-hidden="true">
Â  Â  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editDebtTitle">
Â  Â  Â  <div id="editDebtTitle" class="title">à¹à¸à¹‰à¹„à¸‚à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</div>
Â  Â  Â  <input id="editDebtId" type="hidden">
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="col"><label for="editDebtName">à¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰</label><input id="editDebtName" placeholder="à¹€à¸Šà¹ˆà¸™ à¸šà¸±à¸•à¸£ X / à¹€à¸à¸·à¹ˆà¸­à¸™ A"></div>
Â  Â  Â  Â  <div class="col"><label for="editDebtRate">à¸­à¸±à¸•à¸£à¸²à¸”à¸­à¸à¸•à¹ˆà¸­à¸›à¸µ (%)</label><input id="editDebtRate" type="number" step="0.01"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btnEditDebtCancel" class="btn-ghost">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button id="btnEditDebtSave" class="btn-green">à¸šà¸±à¸™à¸—à¸¶à¸</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="pop" aria-live="assertive" role="alertdialog" aria-modal="true">
Â  Â  <div class="pop-box">
Â  Â  Â  <div class="pop-icon">âœ“</div>
Â  Â  Â  <div class="pop-msg" id="popMsg">à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>
Â  Â  </div>
Â  </div>

Â  <div id="toast" aria-live="polite" role="status">à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™</div>
Â  <div id="overlay"><div class="spinner" aria-hidden="true"></div></div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbznJMWIaEVx9NQurW2PO38SUQPSRoYFzSmhZCjNUIDJEFRLv1JmDC2XsQCoBUIlAbm8Uw/exec';
const BUD_CAT_OVERALLÂ  Â = '__BUDGET_OVERALL__';
const BUD_CAT_SAVE_GOAL = '__SAVING_GOAL__';

/* ===== STATE ===== */
let token = localStorage.getItem('fin_token') || '';
let displayName = localStorage.getItem('fin_name') || '';
let lastItems = [];
let withdrawIncomeIds = new Set();
let debtsCache = []; // active debts
const monthSettingsCache = {}; // { 'YYYY-MM': {budget, goal} }

/* ===== HELPERS ===== */
const $Â  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
function toast(msg, ok=true){ const el=$('#toast'); el.textContent=msg; el.style.background=ok?'#34d399':'#f87171'; el.style.color='#fff'; el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',2400); }
function popSuccess(msg='à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'){ const p=$('#pop'); $('#popMsg').textContent=msg; p.classList.add('show'); clearTimeout(popSuccess._t); popSuccess._t=setTimeout(()=> p.classList.remove('show'), 1300); }
const showOverlay = (on)=> $('#overlay').classList.toggle('show', !!on);
const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
function todayISO(){ return toYMD(new Date()); }
function monthBoundsOf(d){ return { start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) }; }
function monthKeyNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function monthKeyFromRange(){ const f=$('#fFrom').value; if(!f) return monthKeyNow(); return f.slice(0,7); }
const sum = (arr, pick) => arr.reduce((s,x)=> s+(pick(x)||0), 0);
const groupBy = (arr, key) => arr.reduce((a,x)=> ((a[key(x)] = a[key(x)]||[]).push(x),a),{});
const runningSum = (arr)=>{ let s=0; return arr.map(v=>(s+=v,s)); };
const safeKey = (x)=> `${(x.date||'').slice(0,10)}T${(x.time||'00:00:00').slice(0,8)}`;
const clamp = (v,min,max)=> Math.min(max, Math.max(min, v||0));

/* Clear form on Add tab */
function clearAddForm(){
Â  $('#txDate').value = todayISO();
Â  setType('expense');
Â  $('#txAmount').value=''; $('#txNote').value='';
Â  $('#txInt').value=''; $('#txPrin').value='';
Â  if ($('#txCat').options.length) $('#txCat').selectedIndex = 0;
Â  if ($('#txDebt').options.length) $('#txDebt').selectedIndex = 0;
}

/* ===== fetch with timeout & light retry ===== */
async function fetchJSON(url, options={}, timeoutMs=20000){
Â  const controller = new AbortController();
Â  const id = setTimeout(()=>controller.abort(), timeoutMs);
Â  try{
Â  Â  const res = await fetch(url, { ...options, signal: controller.signal });
Â  Â  const text = await res.text();
Â  Â  let j; try { j = JSON.parse(text); } catch(e){ return { ok:false, error:'NON_JSON', raw:text }; }
Â  Â  return j;
Â  }catch(e){ return { ok:false, error:'NETWORK_ERROR', message:String(e&&e.message||e) }; }
Â  finally{ clearTimeout(id); }
}
async function api(path, payload={}, useToken=true, withOverlay=false){
Â  const body = { path, payload }; if (useToken && token) body.token = token;
Â  if (withOverlay) showOverlay(true);
Â  const isList = /\/list$/.test(path) || path.endsWith('transactions/list');
Â  try{
Â  Â  const call = ()=> fetchJSON(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
Â  Â  let j = await call();
Â  Â  if ((!j.ok && j.error==='NETWORK_ERROR') && isList) j = await call();
Â  Â  if (!j.ok && (j.error==='BAD_TOKEN' || j.error==='UNAUTHORIZED' || j.status===401)){
Â  Â  Â  localStorage.removeItem('fin_token'); token=''; ensureLoginUI(); toast('à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ à¹‚à¸›à¸£à¸”à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹ƒà¸«à¸¡à¹ˆ', false);
Â  Â  }
Â  Â  if (!j.ok && j.error==='NON_JSON'){ toast('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸ˆà¸²à¸à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™ JSON)', false); }
Â  Â  return j;
Â  }finally{ if (withOverlay) showOverlay(false); }
}

/* ===== BUDGETS ===== */
async function loadMonthSettingsFromAPI(mk){
Â  const r = await api('budgets/list', { month: mk }, true, false);
Â  let budget=0, goal=0;
Â  if (r.ok){
Â  Â  for (const it of (r.items||[])) {
Â  Â  Â  const cid = String(it.category_id);
Â  Â  Â  if (cid === BUD_CAT_OVERALL)Â  Â budget = Number(it.limit_amount||0);
Â  Â  Â  if (cid === BUD_CAT_SAVE_GOAL) goalÂ  Â = Number(it.limit_amount||0);
Â  Â  }
Â  }
Â  monthSettingsCache[mk] = { budget, goal };
Â  $('#budgetThisMonth').value = budget ? String(budget) : '';
Â  $('#savingGoalThisMonth').value = goal ? String(goal) : '';
Â  return { budget, goal };
}
async function saveMonthSettingsToAPI(mk, budget, goal){
Â  const [r1, r2] = await Promise.all([
Â  Â  api('budgets/upsert', { month: mk, category_id: BUD_CAT_OVERALL,Â  Â limit_amount: Number(budget||0) }, true, true),
Â  Â  api('budgets/upsert', { month: mk, category_id: BUD_CAT_SAVE_GOAL, limit_amount: Number(goal||0)Â  Â }, true, true),
Â  ]);
Â  if (r1.ok && r2.ok){
Â  Â  monthSettingsCache[mk] = { budget:Number(budget||0), goal:Number(goal||0) };
Â  Â  $('#budgetThisMonth').value = budget ? String(budget) : '';
Â  Â  $('#savingGoalThisMonth').value = goal ? String(goal) : '';
Â  Â  return true;
Â  }
Â  return false;
}

/* ===== LOGIN & TABS ===== */
function switchTab(name){
Â  $$('.nav-btn').forEach(b=>{ // Changed from .tabbtn to .nav-btn
Â  Â  const on = (b.dataset.tab===name);
Â  Â  b.classList.toggle('active', on);
Â  });
Â  $$('.section').forEach(s=>{
Â  Â  const on = (s.id === 'tab-'+name);
Â  Â  s.classList.toggle('active', on);
Â  Â  if (on) { s.setAttribute('tabindex','-1'); s.focus({ preventScroll: true }); }
Â  });
Â  if (name==='dash'){ ensureRangeDefaults(); refreshDash(); }
Â  if (name==='list'){ refreshDash(true); }
Â  if (name==='debt'){ ensureDebtDefaults(); loadDebtsUI(); }
}
$$('.nav-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

function ensureLoginUI(){
Â  if (token){
Â  Â  $('#loginBox').classList.add('hide'); $('#app').classList.remove('hide');
    document.querySelector('.bottom-nav').style.display = 'flex';
Â  Â  $('#who').textContent = displayName || localStorage.getItem('fin_user') || '';
Â  Â  $('#txDate').value = todayISO();
Â  Â  ensureRangeDefaults();
Â  Â  loadCategoriesAll().then(async () => {
Â  Â  Â  populateCatSelect(); renderQAs();
Â  Â  Â  await loadMonthSettingsFromAPI(monthKeyFromRange());
Â  Â  Â  await loadDebtsCache();
Â  Â  Â  fillDebtPickers();
Â  Â  Â  setTimeout(()=> $('#txAmount')?.focus(), 120);
Â  Â  });
Â  Â  refreshDash(true);
Â  } else {
Â  Â  $('#loginBox').classList.remove('hide'); $('#app').classList.add('hide');
    document.querySelector('.bottom-nav').style.display = 'none';
Â  }
}

/* LOGIN */
$('#btnLogin').addEventListener('click', doLogin);
$('#inpPin').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doLogin(); });
async function doLogin(){
Â  const user_id = $('#inpUser').value.trim();
Â  const pin = $('#inpPin').value.trim();
Â  if (!user_id || !pin){ $('#loginMsg').textContent='à¸à¸£à¸­à¸à¹ƒà¸«à¹‰à¸„à¸£à¸š'; toast('à¸à¸£à¸­à¸à¹ƒà¸«à¹‰à¸„à¸£à¸š', false); return; }
Â  $('#btnLogin').disabled = true; $('#loginMsg').textContent = 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š...';
Â  const j = await api('auth/login', { user_id, pin }, false, false);
Â  $('#btnLogin').disabled = false;
Â  if (!j.ok){ const msg=(j.error==='USER_NOT_FOUND')?'à¹„à¸¡à¹ˆà¸à¸šà¸šà¸±à¸à¸Šà¸µà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰':(j.error==='BAD_PIN')?'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸œà¸´à¸”':(j.message||'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); $('#loginMsg').textContent=msg; toast(msg,false); return; }
Â  token = j.token; displayName = j.display_name || user_id;
Â  localStorage.setItem('fin_token', token); localStorage.setItem('fin_user', user_id); localStorage.setItem('fin_name', displayName);
Â  $('#loginMsg').textContent = ''; toast('à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š!'); ensureLoginUI(); switchTab('add');
}
$('#btnLogout').addEventListener('click', ()=>{
Â  localStorage.removeItem('fin_token'); localStorage.removeItem('fin_name'); localStorage.removeItem('fin_user');
Â  token=''; displayName=''; $('#inpUser').value=''; $('#inpPin').value=''; $('#loginMsg').textContent=''; ensureLoginUI();
});

/* ===== CATEGORIES ===== */
let cats = { income:[], expense:[], saving:[] };
function _isWithdrawIncomeName(name){ const s = String(name||''); return /à¸–à¸­à¸™.*à¸­à¸­à¸¡|à¸­à¸­à¸¡.*à¸–à¸­à¸™|à¸–à¸­à¸™à¸­à¸­à¸¡|à¸–à¸­à¸™à¹€à¸‡à¸´à¸™à¸­à¸­à¸¡|withdraw.*(save|saving)|saving.*withdraw/i.test(s); }
async function loadCategoriesAll(){
Â  for (const t of ['income','expense','saving']){
Â  Â  const r = await api('categories/list', { type:t });
Â  Â  cats[t] = r.ok ? (r.items||[]) : [];
Â  }
Â  withdrawIncomeIds = new Set((cats.income||[]).filter(c=> _isWithdrawIncomeName(c.name_th)).map(c=> c.category_id));
}
function populateCatSelect(){
Â  const t = $('#txType').value; const sel = $('#txCat'); sel.innerHTML='';
Â  (cats[t]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.category_id; o.textContent=c.name_th; sel.appendChild(o); });
}
$('#txType').addEventListener('change', populateCatSelect);

/* Add Category Modal */
function openAddCatModal(){ $('#addCatType').value = $('#txType').value || 'expense'; $('#addCatName').value = ''; $('#addCatBackdrop').classList.add('show'); $('#addCatBackdrop').setAttribute('aria-hidden','false'); setTimeout(()=> $('#addCatName').focus(), 30); }
function closeAddCatModal(){ $('#addCatBackdrop').classList.remove('show'); $('#addCatBackdrop').setAttribute('aria-hidden','true'); }
$('#btnAddCatInline').addEventListener('click', openAddCatModal);
$('#btnAddCatCancel').addEventListener('click', closeAddCatModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAddCatModal(); });
async function createCategoryFromModal(){
Â  const type = $('#addCatType').value; const name = $('#addCatName').value.trim();
Â  if (!name){ toast('à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸§à¸”à¸à¹ˆà¸­à¸™', false); $('#addCatName').focus(); return; }
Â  const r = await api('categories/create', { name_th:name, type }, true, true);
Â  if (!r.ok){ toast('à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); return; }
Â  const newCatId = String(r.category_id || '');
Â  const newCatObj = { category_id: newCatId, name_th: name, type, user_id: 'self', is_active: true };
Â  cats[type] = [newCatObj, ...(cats[type]||[])];
Â  setType(type); populateCatSelect(); if (newCatId) $('#txCat').value = newCatId;
Â  closeAddCatModal();
Â  popSuccess('à¹€à¸à¸´à¹ˆà¸¡à¸«à¸¡à¸§à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); loadCategoriesAll().catch(()=>{});
}
$('#btnAddCatSave').addEventListener('click', createCategoryFromModal);
$('#addCatName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); createCategoryFromModal(); } });

/* ===== TYPE SWITCH (à¸£à¸§à¸¡ debt) ===== */
function setType(type){
Â  $('#txType').value = type;
Â  $$('#tab-add .btn-ghost').forEach(el => el.classList.remove('active'));
Â  
  if (type === 'expense') $('#btnTypeExp').classList.add('active');
  if (type === 'income') $('#btnTypeInc').classList.add('active');
  if (type === 'saving') $('#btnTypeSav').classList.add('active');
  if (type === 'debt_repay') $('#btnTypeDebtRepay').classList.add('active');
  if (type === 'debt_borrow') $('#btnTypeDebtBorrow').classList.add('active');

Â  const debtMode = (type==='debt_repay' || type==='debt_borrow');
Â  $('#colCat').classList.toggle('hide', debtMode);
Â  $('#colDebt').classList.toggle('hide', !debtMode);

Â  const isRepay = (type==='debt_repay');
Â  $('#colDebtRepayFields').classList.toggle('hide', !isRepay);
Â  $('#colAmount').classList.toggle('hide', isRepay);

Â  if (!debtMode) { populateCatSelect(); }
Â  else { fillDebtPickers(); }
}
$('#btnTypeExp').addEventListener('click', ()=> setType('expense'));
$('#btnTypeInc').addEventListener('click', ()=> setType('income'));
$('#btnTypeSav').addEventListener('click', ()=> setType('saving'));
$('#btnTypeDebtRepay').addEventListener('click', ()=> setType('debt_repay'));
$('#btnTypeDebtBorrow').addEventListener('click', ()=> setType('debt_borrow'));

/* ===== QUICK ADD ===== */
function getQAs(){ try{ return JSON.parse(localStorage.getItem('fin_quick_add')||'[]'); }catch{return [];} }
function setQAs(v){ localStorage.setItem('fin_quick_add', JSON.stringify(v)); }
function renderQAs(){
Â  const wrap = $('#quickWrap'); wrap.innerHTML='';
Â  const list = getQAs();
Â  if (!list.length){ wrap.innerHTML='<span class="muted">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ Quick Add â€” à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸²à¸‡à¸¥à¹ˆà¸²à¸‡à¹„à¸”à¹‰à¹€à¸¥à¸¢</span>'; return; }
Â  for (const q of list){
Â  Â  const b = document.createElement('button');
Â  Â  b.className='qa'; b.title='à¹à¸•à¸°à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸—à¸±à¸™à¸—à¸µ â€¢ à¹à¸•à¸°à¸„à¹‰à¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¸¥à¸š'; b.textContent = q.label;
Â  Â  b.addEventListener('click', ()=> quickAddCommit(q));
Â  Â  const x = document.createElement('span'); x.className='x'; x.textContent='Ã—';
Â  Â  x.addEventListener('click', (e)=>{ e.stopPropagation(); setQAs(list.filter(x=>x.id!==q.id)); renderQAs(); });
Â  Â  b.appendChild(x);
Â  Â  let pressT=null;
Â  Â  const start=()=>{ pressT=setTimeout(()=>{ setQAs(list.filter(x=>x.id!==q.id)); renderQAs(); toast('à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸”à¹ˆà¸§à¸™à¹à¸¥à¹‰à¸§'); },700); };
Â  Â  const end=()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } };
Â  Â  b.addEventListener('touchstart', start, {passive:true});
Â  Â  b.addEventListener('touchend', end, {passive:true});
Â  Â  b.addEventListener('touchmove', end, {passive:true});
Â  Â  b.addEventListener('contextmenu', (e)=>{ e.preventDefault(); setQAs(list.filter(x=>x.id!==q.id)); renderQAs(); });
Â  Â  wrap.appendChild(b);
Â  }
}
function addQA(label, type, amount){
Â  const list = getQAs();
Â  const amt = Number(amount);
Â  if (!label || !isFinite(amt) || amt<=0){ toast('à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡ Quick Add à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  list.unshift({ id: Date.now(), label, type, amount: Math.round(amt*100)/100 });
Â  setQAs(list.slice(0,12)); renderQAs(); $('#qaLabel').value=''; $('#qaAmount').value='';
}
async function quickAddCommit(q){
Â  const arr = cats[q.type]||[]; if (!arr.length){ toast('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¡à¸§à¸”à¸ªà¸³à¸«à¸£à¸±à¸šà¸Šà¸™à¸´à¸”à¸™à¸µà¹‰', false); return; }
Â  const payload = { date: todayISO(), type: q.type, category_id: arr[0].category_id, amount: q.amount, note: q.label };
Â  const r = await api('transactions/create', payload, true, true);
Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); refreshDash(true); } else toast('à¸šà¸±à¸™à¸—à¸¶à¸à¸”à¹ˆà¸§à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
}
$('#btnAddQA').addEventListener('click', ()=> addQA($('#qaLabel').value.trim(), $('#qaType').value, $('#qaAmount').value));

/* ===== ADD TRANSACTION (à¸£à¸§à¸¡ debt) ===== */
function normalizeAmount(v){ const n=Number(v); if (!isFinite(n) || n<=0) return NaN; return Math.round(n*100)/100; }
async function saveTx(){
Â  const type = $('#txType').value;
Â  const date = $('#txDate').value;
Â  const note = $('#txNote').value.trim();
Â  if (!date){ toast('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ', false); return; }

Â  $('#btnSave').disabled = true;

Â  // à¹‚à¸«à¸¡à¸”à¸«à¸™à¸µà¹‰
Â  if (type==='debt_repay' || type==='debt_borrow'){
Â  Â  const debt_id = $('#txDebt').value;
Â  Â  if (!debt_id){ toast('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰', false); $('#btnSave').disabled=false; return; }

Â  Â  if (type==='debt_repay'){
Â  Â  Â  const interest = Number($('#txInt').value||0);
Â  Â  Â  const principal = Number($('#txPrin').value||0);
Â  Â  Â  const amount = Math.round((interest + principal) * 100) / 100;
Â  Â  Â  if (!(isFinite(amount) && amount>0)){ toast('à¹ƒà¸ªà¹ˆà¸¢à¸­à¸”à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸/à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); $('#btnSave').disabled=false; return; }
Â  Â  Â  const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
Â  Â  Â  $('#btnSave').disabled = false;
Â  Â  Â  if (r.ok){
Â  Â  Â  Â  popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  clearAddForm();
Â  Â  Â  Â  await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
Â  Â  Â  } else { toast(r.message||'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); }
Â  Â  Â  return;
Â  Â  } else {
Â  Â  Â  const amount = normalizeAmount($('#txAmount').value);
Â  Â  Â  if (isNaN(amount)){ toast('à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); $('#btnSave').disabled=false; return; }
Â  Â  Â  const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
Â  Â  Â  $('#btnSave').disabled = false;
Â  Â  Â  if (r.ok){
Â  Â  Â  Â  popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  Â  Â  clearAddForm();
Â  Â  Â  Â  await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
Â  Â  Â  } else { toast(r.message||'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); }
Â  Â  Â  return;
Â  Â  }
Â  }

Â  // à¹‚à¸«à¸¡à¸”à¸—à¸±à¹ˆà¸§à¹„à¸›
Â  const amount = normalizeAmount($('#txAmount').value);
Â  const category_id = $('#txCat').value;
Â  if (isNaN(amount)){ toast('à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); $('#btnSave').disabled=false; return; }
Â  if (!category_id){ toast('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸§à¸”', false); $('#btnSave').disabled=false; return; }

Â  const payload = { date, type, category_id, amount, note };
Â  const r = await api('transactions/create', payload, true, true);
Â  $('#btnSave').disabled = false;
Â  if (r.ok){
Â  Â  popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
Â  Â  clearAddForm();
Â  Â  refreshDash(true); $('#txAmount').focus();
Â  } else {
Â  Â  toast('à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
Â  }
}
$('#btnSave').addEventListener('click', ()=> saveTx());
$('#tab-add').addEventListener('keydown', (e)=>{ if (e.key==='Enter' && e.target.tagName !== 'BUTTON'){ e.preventDefault(); saveTx(); } });

/* ===== DASHBOARD ===== */
let chartExp=null, chartFlow=null, chartSavCum=null, chartDebtTS=null, chartPI=null;
function setKpiLoading(on){
Â  ['sumIncome','sumExpense','sumSaving','sumNet','sumDebt'].forEach(id=>{
Â  Â  const el=$('#'+id);
Â  Â  if (on){ el.classList.add('skeleton'); el.textContent=''; }
Â  Â  elseÂ  Â { el.classList.remove('skeleton'); }
Â  });
}
function colorizeNetCard(netVal){ $('#netCard').style.border = netVal>=0 ? '1px solid #a7f3d0' : '1px solid #fecaca'; }
function setRangeDaysBack(days){
Â  const now = new Date(); const from = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to = toYMD(now);
Â  $('#fFrom').value = from; $('#fTo').value = to; onRangeChange();
}
$('#btnToday').addEventListener('click', ()=>{ const d=todayISO(); $('#fFrom').value=d; $('#fTo').value=d; onRangeChange(); });
$('#btn7').addEventListener('click', ()=> setRangeDaysBack(7));
$('#btn30').addEventListener('click', ()=> setRangeDaysBack(30));
$('#btnMonth').addEventListener('click', ()=>{ const mb=monthBoundsOf(new Date()); $('#fFrom').value=mb.start; $('#fTo').value=mb.end; onRangeChange(); });
$('#btnYear').addEventListener('click', ()=>{ const y=new Date().getFullYear(); $('#fFrom').value=`${y}-01-01`; $('#fTo').value=`${y}-12-31`; onRangeChange(); });
$('#btnRefresh').addEventListener('click', ()=> refreshDash());
$('#btnSaveBudget').addEventListener('click', async ()=>{
Â  const mk = monthKeyFromRange();
Â  const ok = await saveMonthSettingsToAPI(mk, $('#budgetThisMonth').value, $('#savingGoalThisMonth').value);
Â  if (ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸š/à¹€à¸›à¹‰à¸²à¸­à¸­à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); await refreshDash(true); }
Â  else toast('à¸šà¸±à¸™à¸—à¸¶à¸à¸‡à¸š/à¹€à¸›à¹‰à¸²à¸­à¸­à¸¡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
});
function onRangeChange(){ updateRangeUI(); refreshDash(); }
$('#fFrom').addEventListener('change', onRangeChange);
$('#fTo').addEventListener('change', onRangeChange);

/* ===== RANGE BADGE ===== */
function ensureRangeDefaults(){
Â  if (!$('#fFrom').value || !$('#fTo').value){
Â  Â  const now = new Date(); const mb = monthBoundsOf(now);
Â  Â  $('#fFrom').value = mb.start; $('#fTo').value = mb.end;
Â  }
Â  updateRangeUI();
}
function updateRangeUI(){
Â  const f=$('#fFrom').value, t=$('#fTo').value;
Â  const today=todayISO(); const mb = monthBoundsOf(new Date());
Â  const now=new Date();
Â  const last7Â  = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-6));
Â  const last30 = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-29));
Â  const yStart= `${now.getFullYear()}-01-01`, yEnd=`${now.getFullYear()}-12-31`;

Â  const isToday = (f===today && t===today);
Â  const is7Â  Â  Â = (f===last7Â  && t===today);
Â  const is30Â  Â  = (f===last30 && t===today);
Â  const isMonth = (f===mb.start && t===mb.end);
Â  const isYearÂ  = (f===yStart && t===yEnd);
  
  $$('.segbtn').forEach(b => b.classList.remove('active'));

Â  if(isToday) $('#btnToday').classList.add('active');
Â  else if(is7) $('#btn7').classList.add('active');
Â  else if(is30) $('#btn30').classList.add('active');
Â  else if(isMonth) $('#btnMonth').classList.add('active');
Â  else if(isYear) $('#btnYear').classList.add('active');

Â  let txt='à¸à¸³à¸«à¸™à¸”à¹€à¸­à¸‡';
Â  if (isToday) txt='à¸§à¸±à¸™à¸™à¸µà¹‰';
Â  else if (is7) txt='7 à¸§à¸±à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”';
Â  else if (is30) txt='30 à¸§à¸±à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”';
Â  else if (isMonth) txt='à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰';
Â  else if (isYear) txt='à¸›à¸µà¸™à¸µà¹‰';
Â  $('#rangeBadge').textContent = txt;
}

/* ===== DEBTS MODULE ===== */
async function loadDebtsCache(){
Â  const r = await api('debts/list', {}, true, false);
Â  debtsCache = r.ok ? (r.items||[]) : [];
Â  fillDebtPickers();
}
function fillDebtPickers(){
Â  const selects = ['#txDebt','#dqDebt','#dtDebt'];
Â  selects.forEach(sel=>{
Â  Â  const el = $(sel); if (!el) return;
Â  Â  const keep = el.value;
Â  Â  el.innerHTML = (sel==='#dtDebt') ? '<option value="">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</option>' : '';
Â  Â  (debtsCache||[]).forEach(d=>{
Â  Â  Â  const o=document.createElement('option');
Â  Â  Â  o.value=d.debt_id; o.textContent=d.lender_name || d.debt_id;
Â  Â  Â  el.appendChild(o);
Â  Â  });
Â  Â  if (keep) el.value = keep;
Â  });
}
function ensureDebtDefaults(){
Â  if (!$('#dqDate').value) $('#dqDate').value = todayISO();
Â  if (!$('#dtFrom').value || !$('#dtTo').value){
Â  Â  const mb = monthBoundsOf(new Date()); $('#dtFrom').value = mb.start; $('#dtTo').value = mb.end;
Â  }
}

/* toggle quick debt UI */
$('#dqType').addEventListener('change', ()=>{
Â  const t = $('#dqType').value;
Â  const isRepay = (t==='repay');
Â  $('#dqColRepay1').classList.toggle('hide', !isRepay);
Â  $('#dqColRepay2').classList.toggle('hide', !isRepay);
Â  $('#dqColAmount').classList.toggle('hide', isRepay);
});
$('#dqType').dispatchEvent(new Event('change'));

/* Add/Quick debt */
$('#btnAddDebt').addEventListener('click', async ()=>{
Â  const lender_name = $('#dName').value.trim();
Â  const annual_rate = Number($('#dRate').value||0);
Â  const principal_initial = Number($('#dPrincipal').value||0);
Â  if (!lender_name || !isFinite(annual_rate) || annual_rate<0){ toast('à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¸­à¸±à¸•à¸£à¸²à¸”à¸­à¸à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  const payload = { lender_name, annual_rate, principal_initial: isFinite(principal_initial)&&principal_initial>0? principal_initial:0, start_date: todayISO() };
Â  const r = await api('debts/create', payload, true, true);
Â  if (r.ok){ popSuccess('à¹€à¸à¸´à¹ˆà¸¡à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); $('#dName').value=''; $('#dRate').value=''; $('#dPrincipal').value=''; await loadDebtsUI(); fillDebtPickers(); refreshDash(true); }
Â  else toast(r.message||'à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
});
$('#btnDebtQuick').addEventListener('click', async ()=>{
Â  const type = $('#dqType').value; const debt_id = $('#dqDebt').value; const date = $('#dqDate').value; const note = $('#dqNote').value.trim();
Â  if (!debt_id || !date){ toast('à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š', false); return; }
Â  if (type==='repay'){
Â  Â  const interest = Number($('#dqInt').value||0);
Â  Â  const principal = Number($('#dqPrin').value||0);
Â  Â  const amount = Math.round((interest + principal) * 100)/100;
Â  Â  if (!(isFinite(amount)&&amount>0)){ toast('à¹ƒà¸ªà¹ˆà¸¢à¸­à¸”à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸/à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  Â  const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
Â  Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); $('#dqInt').value=''; $('#dqPrin').value=''; $('#dqNote').value=''; await loadDebtsUI(); refreshDash(true); }
Â  Â  else toast(r.message||'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
Â  }else{
Â  Â  const amount = Number($('#dqAmount').value||0);
Â  Â  if (!(isFinite(amount)&&amount>0)){ toast('à¹ƒà¸ªà¹ˆà¸¢à¸­à¸”à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  Â  const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
Â  Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); $('#dqAmount').value=''; $('#dqNote').value=''; await loadDebtsUI(); refreshDash(true); }
Â  Â  else toast(r.message||'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
Â  }
});
$('#btnLoadDebtTx').addEventListener('click', loadDebtTxList);
async function loadDebtTxList(){
Â  const from = $('#dtFrom').value, to = $('#dtTo').value, debtId = $('#dtDebt').value;
Â  const r = await api('debts/tx/list', { from, to, debt_id: debtId||undefined }, true, true);
Â  const tb = $('#tblDebtTx'); tb.innerHTML='';
Â  if (!r.ok){ toast('à¹‚à¸«à¸¥à¸”à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); return; }
Â  const items = (r.items||[]);
Â  const nameMap = Object.fromEntries((debtsCache||[]).map(d=>[d.debt_id, d.lender_name]));
Â  for (const x of items){
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td>${esc((x.date||'').slice(0,10))}</td>
Â  Â  Â  <td><span class="badge badge-debt">${x.type==='borrow'?'à¸à¸¹à¹‰à¸«à¸™à¸µà¹‰':'à¸ˆà¹ˆà¸²à¸¢à¸«à¸™à¸µà¹‰'}</span></td>
Â  Â  Â  <td>${esc(nameMap[x.debt_id] || x.debt_id)}</td>
Â  Â  Â  <td class="right">${fmt(x.amount)}</td>
Â  Â  Â  <td class="right">${fmt(x.interest_paid||0)}</td>
Â  Â  Â  <td class="right">${fmt(x.principal_paid||0)}</td>
Â  Â  Â  <td class="right">${fmt(x.overpay||0)}</td>
Â  Â  Â  <td>${esc(x.note||'')}</td>`;
Â  Â  tb.appendChild(tr);
Â  }
}

/* ===== DASHBOARD: refresh & KPIs ===== */
async function refreshDash(silent){
Â  if (!token){ if(!silent) toast('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸š token (à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™)', false); return; }
Â  setKpiLoading(true);
Â  if (!cats.expense.length && !cats.income.length && !cats.saving.length){ await loadCategoriesAll(); }
Â  await loadDebtsCache();

Â  const mk = monthKeyFromRange();
Â  await loadMonthSettingsFromAPI(mk).catch(()=>{});

Â  const from = $('#fFrom').value, to = $('#fTo').value;
Â  const [rTx, rDebtSum] = await Promise.all([
Â  Â  api('transactions/list', { from, to, type:'all' }),
Â  Â  api('debts/summary', {}, true, false)
Â  ]);
Â  if (!rTx.ok){ setKpiLoading(false); if(!silent) toast('à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸à¸²à¸£à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); return; }
Â  lastItems = (rTx.items||[]).map(x=> ({...x, amount:+x.amount}));

Â  const inc = sum(lastItems, x=> x.type==='income'? x.amount:0);
Â  const exp = sum(lastItems, x=> x.type==='expense'? x.amount:0);
Â  const savDep = sum(lastItems, x=> x.type==='saving'? x.amount:0);
Â  const savWdÂ  = sum(lastItems, x=> x.type==='income' && withdrawIncomeIds.has(x.category_id) ? x.amount : 0);
Â  const savNet = savDep - savWd;
Â  const netÂ  Â  = inc - exp - savDep;

Â  $('#sumIncome').textContent = fmt(inc);
Â  $('#sumExpense').textContent = fmt(exp);
Â  $('#sumSaving').textContentÂ  = fmt(Math.max(0, savNet));
Â  $('#sumNet').textContentÂ  Â  Â = fmt(net);
Â  colorizeNetCard(net);
Â  $('#sumDebt').textContent = rDebtSum.ok ? fmt(Number(rDebtSum.totals?.total||0)) : 'â€”';
Â  setKpiLoading(false);

Â  await updateBudgetUI(exp, Math.max(0,savNet), mk);

Â  const mapCat = Object.fromEntries((cats.expense.concat(cats.income).concat(cats.saving)).map(c=> [c.category_id, c.name_th]));
Â  drawExpByCat(lastItems, mapCat);
Â  drawFlow(lastItems);
Â  drawSavingCum(lastItems);
Â  renderTable(lastItems, mapCat);

Â  await drawDebtTimeSeries_PrincipalOnly(from, to);
Â  await drawPrincipalInterestMonthly_Manual(from, to);
}
async function updateBudgetUI(expenseTotal, savingNet, mk){
Â  const cache = monthSettingsCache[mk] || { budget:0, goal:0 };
Â  const b = Number(cache.budget||0), g = Number(cache.goal||0);

Â  const pct = (!b || b<=0) ? 0 : Math.round((expenseTotal/b)*100);
Â  $('#budgetUsedPct').textContent = b>0 ? `${pct}%` : 'â€”';
Â  $('#budgetBar').style.width = (b>0 ? Math.min(pct,100) : 0) + '%';
Â  $('#budgetBar').style.filter = (pct>=100)? 'saturate(1.5)' : (pct>=80? 'saturate(1.2)' : 'none');

Â  let bTxt = 'à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰: â€”';
Â  if (b>0){
Â  Â  if (expenseTotal > b) bTxt = `à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰: à¹€à¸à¸´à¸™à¸¡à¸² ${fmt(expenseTotal - b)}`;
Â  Â  elseÂ  Â  Â  Â  Â  Â  Â  Â  Â  bTxt = `à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰: à¹€à¸«à¸¥à¸·à¸­à¸‡à¸š ${fmt(b - expenseTotal)}`;
Â  }
Â  $('#budgetStatus').textContent = bTxt;

Â  const savingClamped = Math.max(0, savingNet);
Â  const pctSave = (!g || g<=0) ? 0 : Math.round((savingClamped/g)*100);
Â  $('#savingGoalPct').textContent = g>0 ? `${pctSave}%` : 'â€”';
Â  $('#savingBar').style.width = (g>0 ? Math.min(pctSave,100) : 0) + '%';

Â  let sTxt='â€”';
Â  if (g>0){
Â  Â  if (savingNet>=g) sTxt = `à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸²à¹à¸¥à¹‰à¸§ (+${fmt(savingNet-g)})`;
Â  Â  elseÂ  Â  Â  Â  Â  Â  Â  sTxt = `à¸‚à¸²à¸”à¸­à¸µà¸ ${fmt(g - savingNet)}`;
Â  }
Â  $('#savingGoalStatus').textContent = sTxt;
}

/* Charts */
function drawExpByCat(items, mapCat){
Â  const panelNo = $('#noDataExp'); if (chartExp) chartExp.destroy();
Â  const exps = items.filter(x=>x.type==='expense');
Â  if (!exps.length){ panelNo.classList.remove('hide'); chartExp=null; return; }
Â  panelNo.classList.add('hide');
Â  const groupExp = groupBy(exps, x=> mapCat[x.category_id] || 'à¸­à¸·à¹ˆà¸™ à¹†');
Â  const labels = Object.keys(groupExp);
Â  const data = labels.map(k=> sum(groupExp[k], x=> x.amount));
Â  chartExp = new Chart($('#chartExp'), {
Â  Â  type:'bar',
Â  Â  data:{ labels, datasets:[{ label:'à¸ˆà¸³à¸™à¸§à¸™ (à¸šà¸²à¸—)', data, backgroundColor:'rgba(244, 63, 94, 0.7)', borderColor:'rgba(244, 63, 94, 1)', borderWidth:1, borderRadius: 8 }] },
Â  Â  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ display:false } } }
Â  });
}
function drawFlow(items){
Â  const panelNo = $('#noDataFlow'); if (chartFlow) chartFlow.destroy();
Â  if (!items.length){ panelNo.classList.remove('hide'); chartFlow=null; return; }
Â  panelNo.classList.add('hide');
Â  const g = groupBy(items, x=> x.date);
Â  const ds = Object.keys(g).sort();
Â  const incomeÂ  = ds.map(d=> sum(g[d], x=> x.type==='income'?Â  x.amount:0));
Â  const expense = ds.map(d=> sum(g[d], x=> x.type==='expense'? x.amount:0));
Â  const savingD = ds.map(d=> sum(g[d], x=> x.type==='saving'?Â  x.amount:0));
Â  const netDaily = ds.map((_,i)=> income[i] - expense[i] - savingD[i]);
Â  const netCumulative = runningSum(netDaily);
Â  chartFlow = new Chart($('#chartFlow'), {
Â  Â  type:'line',
Â  Â  data:{ labels: ds,
Â  Â  Â  datasets:[
Â  Â  Â  Â  { label:'à¸£à¸²à¸¢à¸£à¸±à¸š', data:income, borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,.15)', tension:.35, fill:true },
Â  Â  Â  Â  { label:'à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢', data:expense, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,.15)', tension:.35, fill:true },
Â  Â  Â  Â  { label:'à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸ªà¸°à¸ªà¸¡', data:netCumulative, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,.15)', tension:.35, fill:false }
Â  Â  Â  ]
Â  Â  },
Â  Â  options:{ responsive:true, maintainAspectRatio:false, animation:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:true } } }
Â  });
}
function drawSavingCum(items){
Â  const panelNo = $('#noDataSav'); if (chartSavCum) chartSavCum.destroy();
Â  const byDateDep = groupBy(items.filter(x=>x.type==='saving'), x=> x.date);
Â  const byDateWdr = groupBy(items.filter(x=> x.type==='income' && withdrawIncomeIds.has(x.category_id)), x=> x.date);
Â  const dates = Array.from(new Set([...Object.keys(byDateDep), ...Object.keys(byDateWdr)])).sort();
Â  if (!dates.length){ panelNo.classList.remove('hide'); chartSavCum=null; return; }
Â  panelNo.classList.add('hide');
Â  const netPerDay = dates.map(d=>{
Â  Â  const dep = sum(byDateDep[d]||[], x=> x.amount);
Â  Â  const wdr = sum(byDateWdr[d]||[], x=> x.amount);
Â  Â  return dep - wdr;
Â  });
Â  const cum = runningSum(netPerDay);
Â  chartSavCum = new Chart($('#chartSavCum'), {
Â  Â  type:'line',
Â  Â  data:{ labels: dates, datasets:[{ label:'à¸­à¸­à¸¡à¸ªà¸¸à¸—à¸˜à¸´à¸ªà¸°à¸ªà¸¡', data:cum, borderColor:'#2dd4bf', backgroundColor:'rgba(45,212,191,.15)', tension:.35, fill:true }] },
Â  Â  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}}
Â  });
}

/* ===== LIST + EDIT ===== */
function renderTable(items, mapCat){
Â  const tb = $('#tblBody'); tb.innerHTML='';
Â  const sorted = items.slice().sort((a,b)=> safeKey(b).localeCompare(safeKey(a)));
Â  if (!sorted.length){ $('#emptyList').style.display='block'; return; }
Â  $('#emptyList').style.display='none';
Â  for (const x of sorted){
Â  Â  const isWithdrawIncome = (x.type==='income' && withdrawIncomeIds.has(x.category_id));
Â  Â  const typeTxt = x.type==='income'?(isWithdrawIncome?'à¸£à¸²à¸¢à¸£à¸±à¸š (à¸–à¸­à¸™à¸­à¸­à¸¡)':'à¸£à¸²à¸¢à¸£à¸±à¸š'):(x.type==='saving'?'à¸­à¸­à¸¡à¹€à¸‡à¸´à¸™':'à¸£à¸²à¸¢à¸ˆà¹ˆà¸²à¸¢');
Â  Â  const badge = x.type==='income' ? (isWithdrawIncome ? 'badge-sav' : 'badge-inc') : (x.type==='saving' ? 'badge-sav' : 'badge-exp');
Â  Â  const catName = mapCat[x.category_id] || x.category_name || x.category_id || '';
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td title="${esc(x.date||'').slice(0,10)}">${esc((x.date||'').slice(0,10))}</td>
Â  Â  Â  <td><span class="badge ${badge}">${typeTxt}</span></td>
Â  Â  Â  <td>${esc(catName)}</td>
Â  Â  Â  <td class="right">${fmt(x.amount)}</td>
Â  Â  Â  <td>${esc(x.note||'')}</td>
Â  Â  Â  <td><button class="btn-ghost" style="padding: 0.5rem 0.8rem; font-size: 0.85rem;" data-act="edit" data-id="${esc(x.tx_id||'')}">à¹à¸à¹‰à¹„à¸‚</button></td>`;
Â  Â  tb.appendChild(tr);
Â  }
}
$('#tblBody').addEventListener('click', (e)=>{
Â  const btn = e.target.closest && e.target.closest('button[data-act="edit"]');
Â  if (!btn) return;
Â  openEditById(btn.getAttribute('data-id'));
});
function populateEditCatSelect(){
Â  const t = $('#editType').value; const sel = $('#editCat'); sel.innerHTML='';
Â  (cats[t]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.category_id; o.textContent=c.name_th; sel.appendChild(o); });
}
async function openEditById(txId){
Â  if (!txId){ toast('à¹„à¸¡à¹ˆà¸à¸šà¸£à¸«à¸±à¸ªà¸£à¸²à¸¢à¸à¸²à¸£', false); return; }
Â  let it = lastItems.find(x=> String(x.tx_id)===String(txId));
Â  if (!it){
Â  Â  const r = await api('transactions/list', { from: $('#fFrom').value, to: $('#fTo').value, type:'all' });
Â  Â  if (!r.ok){ toast('à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸à¸²à¸£à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); return; }
Â  Â  lastItems = (r.items||[]); it = lastItems.find(x=> String(x.tx_id)===String(txId));
Â  Â  if (!it){ toast('à¸£à¸²à¸¢à¸à¸²à¸£à¸«à¸²à¸¢à¹„à¸›à¹à¸¥à¹‰à¸§', false); return; }
Â  }
Â  $('#editTxId').value = it.tx_id;
Â  $('#editDate').value = (it.date||'').slice(0,10);
Â  $('#editType').value = it.type;
Â  populateEditCatSelect();
Â  $('#editCat').value = it.category_id;
Â  $('#editAmount').value = String(it.amount);
Â  $('#editNote').value = it.note||'';
Â  $('#editBackdrop').classList.add('show'); $('#editBackdrop').setAttribute('aria-hidden','false');
}
function closeEdit(){ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); }
$('#btnCancel').addEventListener('click', closeEdit);
$('#editType').addEventListener('change', populateEditCatSelect);
$('#btnUpdate').addEventListener('click', async ()=>{
Â  const tx_id = $('#editTxId').value;
Â  const amount = Number($('#editAmount').value);
Â  if (!tx_id || !isFinite(amount) || amount<=0){ toast('à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸«à¸£à¸·à¸­à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  const payload = { tx_id, date: $('#editDate').value, type: $('#editType').value, category_id: $('#editCat').value, amount: Math.round(amount*100)/100, note: $('#editNote').value.trim() };
Â  $('#btnUpdate').disabled = true;
Â  const r = await api('transactions/update', payload, true, true);
Â  $('#btnUpdate').disabled = false;
Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸à¹‰à¹„à¸‚à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); closeEdit(); refreshDash(true); }
Â  else toast(r.message||'à¸­à¸±à¸›à¹€à¸”à¸•à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
});
$('#btnDelete').addEventListener('click', async ()=>{
Â  $('#confirmMsg').textContent='à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?';
Â  $('#confirmBackdrop').classList.add('show'); $('#confirmBackdrop').setAttribute('aria-hidden','false');
Â  const ok = await new Promise(resolve=>{
Â  Â  const yes=()=>{ cleanup(); resolve(true); };
Â  Â  const no =()=>{ cleanup(); resolve(false); };
Â  Â  const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
Â  Â  Â  $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
Â  Â  $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
Â  });
Â  if (!ok) return;
Â  const tx_id = $('#editTxId').value; if (!tx_id) return;
Â  $('#btnDelete').disabled = true;
Â  const r = await api('transactions/delete', { tx_id }, true, false);
Â  $('#btnDelete').disabled = false;
Â  if (r.ok){ popSuccess('à¸¥à¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); closeEdit(); refreshDash(true); }
Â  else toast(r.message||'à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
});

/* ===== Debts list + edit modal ===== */
async function loadDebtsUI(){
Â  await loadDebtsCache();
Â  const rSum = await api('debts/summary', {}, true, false);
Â  const mapById = Object.fromEntries((debtsCache||[]).map(d=> [d.debt_id, d]));
Â  const tb = $('#tblDebts'); tb.innerHTML='';
Â  const rows = (rSum.ok ? (rSum.items||[]) : []).map(x=>{
Â  Â  const d = mapById[x.debt_id] || {};
Â  Â  const principal = Number(x.principal_current ?? d.principal_current ?? 0);
Â  Â  const accruedÂ  Â = Number(x.accrued_interestÂ  ?? d.accrued_interestÂ  ?? 0);
Â  Â  const rateÂ  Â  Â  = Number(x.annual_rateÂ  Â  Â  Â ?? d.annual_rateÂ  Â  Â  Â ?? 0);
Â  Â  const total_due = (typeof x.total_due === 'number' && Number.isFinite(x.total_due))
Â  Â  Â  ? x.total_due
Â  Â  Â  : principal + accrued;
Â  Â  return {
Â  Â  Â  debt_id: x.debt_id,
Â  Â  Â  lender_name: x.lender_name || d.lender_name || '',
Â  Â  Â  rate,
Â  Â  Â  principal,
Â  Â  Â  accrued,
Â  Â  Â  total: total_due,
Â  Â  Â  last_calc_date: d.last_calc_date || x.as_of || ''
Â  Â  };
Â  });
Â  if (rows.length === 0) {
Â  Â  tb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸™à¸µà¹‰à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”à¸­à¸¢à¸¹à¹ˆ</td></tr>';
Â  Â  return;
Â  }
Â  for (const r of rows){
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td>${esc(r.lender_name)}</td>
Â  Â  Â  <td class="right">${fmt(r.rate)}</td>
Â  Â  Â  <td class="right">${fmt(r.principal)}</td>
Â  Â  Â  <td class="right">${fmt(r.accrued)}</td>
Â  Â  Â  <td class="right"><b>${fmt(r.total)}</b></td>
Â  Â  Â  <td>${esc((r.last_calc_date||'').slice(0,10))}</td>
Â  Â  Â  <td>
Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  <button class="btn-ghost" data-dact="edit"Â  data-id="${esc(r.debt_id)}">à¹à¸à¹‰à¹„à¸‚</button>
Â  Â  Â  Â  Â  <button class="btn-danger" data-dact="close" data-id="${esc(r.debt_id)}">à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </td>`;
Â  Â  tb.appendChild(tr);
Â  }
}

/* Debt edit modal */
function findClosest(el, selector, stopAt){
Â  if (el && el.nodeType === 3) el = el.parentElement;
Â  while (el && el !== stopAt){
Â  Â  if (el.matches && el.matches(selector)) return el;
Â  Â  el = el.parentElement;
Â  }
Â  return null;
}
function openDebtEdit(id){
Â  const d = debtsCache.find(x=> String(x.debt_id)===String(id));
Â  if (!d){ toast('à¹„à¸¡à¹ˆà¸à¸šà¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰', false); return; }
Â  $('#editDebtId').value = d.debt_id;
Â  $('#editDebtName').value = d.lender_name || '';
Â  $('#editDebtRate').value = (d.annual_rate ?? 0);
Â  $('#editDebtBackdrop').classList.add('show');
Â  $('#editDebtBackdrop').setAttribute('aria-hidden','false');
Â  setTimeout(()=> $('#editDebtName').focus(), 50);
}
function closeDebtEdit(){
Â  $('#editDebtBackdrop').classList.remove('show');
Â  $('#editDebtBackdrop').setAttribute('aria-hidden','true');
}
$('#btnEditDebtCancel').addEventListener('click', closeDebtEdit);
$('#btnEditDebtSave').addEventListener('click', async ()=>{
Â  const id = $('#editDebtId').value;
Â  const name = $('#editDebtName').value.trim();
Â  const rate = Number($('#editDebtRate').value);
Â  if (!id){ toast('à¹„à¸¡à¹ˆà¸à¸šà¸£à¸«à¸±à¸ªà¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰', false); return; }
Â  if (!name){ toast('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸«à¸™à¸µà¹‰', false); return; }
Â  if (!isFinite(rate) || rate<0){ toast('à¸­à¸±à¸•à¸£à¸²à¸”à¸­à¸à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  const r = await api('debts/update', { debt_id:id, lender_name:name, annual_rate:Math.round(rate*100)/100 }, true, true);
Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸à¹‰à¹„à¸‚à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); closeDebtEdit(); await loadDebtsUI(); refreshDash(true); }
Â  else toast(r.message||'à¸­à¸±à¸›à¹€à¸”à¸•à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
});
$('#tblDebts').addEventListener('click', async (e)=>{
Â  const btn = findClosest(e.target, 'button[data-dact]', e.currentTarget);
Â  if (!btn) return;
Â  const id = btn.getAttribute('data-id');
Â  const act = btn.getAttribute('data-dact');

Â  if (act==='close'){
Â  Â  $('#confirmMsg').textContent = 'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µà¸«à¸™à¸µà¹‰à¸™à¸µà¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?';
Â  Â  $('#confirmBackdrop').classList.add('show'); $('#confirmBackdrop').setAttribute('aria-hidden','false');
Â  Â  const ok = await new Promise(resolve=>{
Â  Â  Â  const yes=()=>{ cleanup(); resolve(true); }; const no =()=>{ cleanup(); resolve(false); };
Â  Â  Â  const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
Â  Â  Â  Â  $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
Â  Â  Â  $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
Â  Â  });
Â  Â  if (!ok) return;
Â  Â  const r = await api('debts/close', { debt_id:id }, true, true);
Â  Â  if (r.ok){ popSuccess('à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); await loadDebtsUI(); refreshDash(true); }
Â  Â  else toast(r.message||'à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
Â  }
Â  if (act==='edit'){ openDebtEdit(id); }
});

/* ===== Debt charts (principal only) ===== */
function normRangeForCharts(from, to){
Â  const today = todayISO();
Â  const end = (!to || to > today) ? today : to;
Â  return { from, end };
}
async function drawDebtTimeSeries_PrincipalOnly(from, to){
Â  const panelNo = $('#noDataDebtTS');
Â  if (chartDebtTS) chartDebtTS.destroy();
Â  const { end } = normRangeForCharts(from, to);
Â  const r = await api('debts/tx/list', { to: end }, true, false);
Â  if (!r.ok){ panelNo.classList.remove('hide'); chartDebtTS=null; return; }
Â  const items = (r.items||[]).map(x=>({
Â  Â  date: String(x.date||''),
Â  Â  type: String(x.type||''),
Â  Â  borrow: Number(x.type==='borrow' ? (x.amount||0) : 0),
Â  Â  prinPaid: Number(x.type==='repay' ? (x.principal_paid||0) : 0)
Â  }));
Â  if (!items.length){ panelNo.classList.remove('hide'); chartDebtTS=null; return; }
Â  const start = from;
Â  const baseBefore = items.filter(x=> x.date < start).reduce((s,x)=> s + x.borrow - x.prinPaid, 0);
Â  const days = dateRangeArray(start, end);
Â  const deltaByDate = {};
Â  for (const it of items){
Â  Â  if (it.date >= start && it.date <= end){
Â  Â  Â  deltaByDate[it.date] = (deltaByDate[it.date]||0) + it.borrow - it.prinPaid;
Â  Â  }
Â  }
Â  let outstanding = baseBefore;
Â  const series = days.map(d=>{ outstanding += (deltaByDate[d]||0); return clamp(outstanding,0,Number.POSITIVE_INFINITY); });
Â  const hasAny = series.some(v=> v>0);
Â  if (!hasAny){ panelNo.classList.remove('hide'); chartDebtTS=null; return; }
Â  panelNo.classList.add('hide');
Â  chartDebtTS = new Chart($('#chartDebtTS'), {
Â  Â  type:'line',
Â  Â  data:{ labels: days, datasets:[{
Â  Â  Â  label:'à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™à¸•à¹‰à¸™à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸£à¸§à¸¡ (à¹„à¸¡à¹ˆà¸„à¸´à¸”à¸”à¸­à¸)',
Â  Â  Â  data: series,
Â  Â  Â  borderColor:'#818cf8', backgroundColor:'rgba(129, 140, 248, .15)', tension:.35, fill:true
Â  Â  }]},
Â  Â  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true } } }
Â  });
}
async function drawPrincipalInterestMonthly_Manual(from, to){
Â  const panelNo = $('#noDataPI'); if (chartPI) chartPI.destroy();
Â  const { end } = normRangeForCharts(from, to);
Â  const r = await api('debts/tx/list', { from, to:end }, true, false);
Â  if (!r.ok || !(r.items||[]).length){ panelNo.classList.remove('hide'); chartPI=null; return; }
Â  panelNo.classList.add('hide');
Â  const g = {};
Â  for (const x of r.items){
Â  Â  if (String(x.type)!=='repay') continue;
Â  Â  const ym = String(x.date||'').slice(0,7);
Â  Â  if (!g[ym]) g[ym] = { prin:0, intr:0 };
Â  Â  g[ym].prin += Number(x.principal_paid||0);
Â  Â  g[ym].intr += Number(x.interest_paid||0);
Â  }
Â  const labels = Object.keys(g).sort();
Â  if (!labels.length){ panelNo.classList.remove('hide'); chartPI=null; return; }
Â  const prin = labels.map(m=> g[m].prin);
Â  const intr = labels.map(m=> g[m].intr);
Â  chartPI = new Chart($('#chartPI'), {
Â  Â  type:'line',
Â  Â  data:{ labels,
Â  Â  Â  datasets:[
Â  Â  Â  Â  { label:'à¸ˆà¹ˆà¸²à¸¢à¸•à¹‰à¸™ (à¸šà¸²à¸—)', data:prin, borderColor:'#34d399', backgroundColor:'rgba(52, 211, 153,.15)', tension:.35, fill:false },
Â  Â  Â  Â  { label:'à¸ˆà¹ˆà¸²à¸¢à¸”à¸­à¸ (à¸šà¸²à¸—)', data:intr, borderColor:'#fbbf24', backgroundColor:'rgba(251, 191, 36,.15)', tension:.35, fill:false },
Â  Â  Â  ] },
Â  Â  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}}
Â  });
}

/* ===== Small utils ===== */
function dateRangeArray(from, to){
Â  const out = []; const df = new Date(from), dt = new Date(to);
Â  if (isNaN(df)||isNaN(dt) || df>dt) return out;
Â  for (let d=new Date(df); d<=dt; d=new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)){ out.push(toYMD(d)); }
Â  return out;
}

/* ===== INIT ===== */
function init(){
Â  setType('expense'); ensureLoginUI();
Â  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') { closeEdit(); closeDebtEdit(); } });
Â  renderQAs();
}
init();

/* ===== [ADD-ON] Quick Add: category picker (à¹€à¸”à¸´à¸¡) ===== */
(function setupQACategoryUI(){
Â  const row = document.querySelector('#tab-add .quickadd .row');
Â  if (!row) return;
Â  const col = document.createElement('div');
Â  col.className = 'col';
Â  col.innerHTML = `<select id="qaCat"><option value="">à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸§à¸” (à¸­à¸´à¸‡à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸”à¹‰à¸²à¸™à¸šà¸™)</option></select>`;
Â  row.insertBefore(col, row.lastElementChild);
Â  const typeSel = document.getElementById('qaType');
Â  typeSel?.addEventListener('change', populateQACat);
Â  populateQACat();
})();
function populateQACat(){
Â  const sel = document.getElementById('qaCat'); const typeSel = document.getElementById('qaType');
Â  if (!sel || !typeSel) return;
Â  const t = typeSel.value || 'expense';
Â  const list = (typeof cats !== 'undefined' && cats[t]) ? cats[t] : [];
Â  sel.innerHTML = `<option value="">à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸§à¸” (à¸­à¸´à¸‡à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸”à¹‰à¸²à¸™à¸šà¸™)</option>`;
Â  list.forEach(c=>{ const o = document.createElement('option'); o.value = c.category_id; o.textContent = c.name_th; sel.appendChild(o); });
}
function _findCat(type, category_id){ const list = (typeof cats !== 'undefined' && cats[type]) ? cats[type] : []; return list.find(c => String(c.category_id) === String(category_id)) || null; }
(function(){
Â  const _addQA_prev = typeof addQA === 'function' ? addQA : null;
Â  window.addQA = function(label, type, amount){
Â  Â  if (!document.getElementById('qaCat')?.options?.length) populateQACat();
Â  Â  const catId = (document.getElementById('qaCat')?.value || '').trim();
Â  Â  const list = (function(){ try{ return JSON.parse(localStorage.getItem('fin_quick_add')||'[]'); }catch{return [];} })();
Â  Â  const amt = Number(amount);
Â  Â  if (!label || !isFinite(amt) || amt<=0){ toast('à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸‚à¸­à¸‡ Quick Add à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡', false); return; }
Â  Â  let catName = ''; if (catId){ const obj = _findCat(type, catId); catName = obj ? (obj.name_th || '') : ''; }
Â  Â  list.unshift({ id: Date.now(), label, type, amount: Math.round(amt*100)/100, category_id: catId || undefined, category_name: catName || undefined });
Â  Â  localStorage.setItem('fin_quick_add', JSON.stringify(list.slice(0,12)));
Â  Â  if (typeof renderQAs === 'function') renderQAs();
Â  Â  const l = document.getElementById('qaLabel'); if (l) l.value=''; const a = document.getElementById('qaAmount'); if (a) a.value='';
Â  };
Â  window.quickAddCommit = async function(q){
Â  Â  let category_id = q && q.category_id ? q.category_id : '';
Â  Â  const t = q?.type || 'expense';
Â  Â  if (!category_id){
Â  Â  Â  const sel = document.getElementById('qaCat');
Â  Â  Â  if (sel && document.getElementById('qaType')?.value === t && sel.value) category_id = sel.value;
Â  Â  }
Â  Â  if (!category_id){
Â  Â  Â  const arr = (typeof cats !== 'undefined' && cats[t]) ? cats[t] : [];
Â  Â  Â  if (!arr.length){ toast('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¡à¸§à¸”à¸ªà¸³à¸«à¸£à¸±à¸šà¸Šà¸™à¸´à¸”à¸™à¸µà¹‰', false); return; }
Â  Â  Â  category_id = arr[0].category_id;
Â  Â  }
Â  Â  const payload = { date: (typeof todayISO === 'function') ? todayISO() : (new Date().toISOString().slice(0,10)), type: t, category_id, amount: q?.amount, note: q?.label };
Â  Â  try{
Â  Â  Â  const r = await api('transactions/create', payload, true, true);
Â  Â  Â  if (r.ok){ popSuccess('à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); if (typeof refreshDash==='function') refreshDash(true); }
Â  Â  Â  else toast('à¸šà¸±à¸™à¸—à¸¶à¸à¸”à¹ˆà¸§à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false);
Â  Â  }catch(e){ toast('à¸šà¸±à¸™à¸—à¸¶à¸à¸”à¹ˆà¸§à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', false); }
Â  };
})();
(function decorateQAChips(){
Â  const _render_prev = typeof renderQAs === 'function' ? renderQAs : null;
Â  window.renderQAs = function(){
Â  Â  if (_render_prev) _render_prev();
Â  Â  const wrap = document.getElementById('quickWrap'); if (!wrap) return;
Â  Â  const list = (function(){ try{ return JSON.parse(localStorage.getItem('fin_quick_add')||'[]'); }catch{return [];} })();
Â  Â  const chips = Array.from(wrap.querySelectorAll('.qa'));
Â  Â  chips.forEach((chip, idx)=>{
Â  Â  Â  const q = list[idx]; if (!q) return;
Â  Â  Â  const name = q.category_name || (q.category_id ? (_findCat(q.type, q.category_id)?.name_th || '') : '');
Â  Â  Â  if (name && !chip.dataset.decorated){
Â  Â  Â  Â  chip.textContent = `${q.label} â€¢ ${name}`;
Â  Â  Â  Â  const x = document.createElement('span'); x.className='x'; x.textContent='Ã—';
Â  Â  Â  Â  x.addEventListener('click', (e)=>{ e.stopPropagation();
Â  Â  Â  Â  Â  const next = list.filter(x=>x.id!==q.id);
Â  Â  Â  Â  Â  localStorage.setItem('fin_quick_add', JSON.stringify(next));
Â  Â  Â  Â  Â  if (typeof renderQAs==='function') renderQAs();
Â  Â  Â  Â  Â  toast('à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸”à¹ˆà¸§à¸™à¹à¸¥à¹‰à¸§');
Â  Â  Â  Â  });
Â  Â  Â  Â  chip.appendChild(x);
Â  Â  Â  Â  chip.dataset.decorated = '1';
Â  Â  Â  }
Â  Â  });
Â  };
})();
</script>
</body>
</html>
